
//====================================== RelOptTable.ViewExpander
//====================================== RelOptTable.ViewExpander

RelOptTable.ViewExpander æ˜¯ ä¸€ä¸ªæ¥å£ï¼Œ
ç”¨äº å±•å¼€è§†å›¾ï¼ˆView Expansionï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š

ï¼ˆ1ï¼‰å¦‚æœ SQL è¯­å¥æ¶‰åŠè§†å›¾ï¼Œè¿™ä¸ªæ¥å£å¯ä»¥å°† è§†å›¾çš„ "SQL è§£æ" å¹¶è½¬æ¢ä¸º "RelNode"ã€‚
ï¼ˆ2ï¼‰å…è®¸ç”¨æˆ· è‡ªå®šä¹‰å¦‚ä½•è§£æå’Œå±•å¼€è§†å›¾ï¼Œä»è€Œæ”¯æŒæ›´çµæ´»çš„è§†å›¾è§£æé€»è¾‘ã€‚

//====================================== ViewExpander çš„æ ¸å¿ƒæ–¹æ³•
//====================================== ViewExpander çš„æ ¸å¿ƒæ–¹æ³•
public interface RelOptTable.ViewExpander {
    RelRoot expandView(RelDataType rowType, String queryString, 
                       List<String> schemaPath, @Nullable List<String> viewPath);
}

å‚æ•°
	ï¼ˆ1ï¼‰rowTypeï¼šè§†å›¾çš„ RelDataTypeï¼ˆåˆ—ç±»å‹ï¼‰ã€‚
	ï¼ˆ2ï¼‰queryStringï¼šè§†å›¾çš„ SQL å®šä¹‰ï¼ˆå¦‚ CREATE VIEW ... AS SELECT ...ï¼‰ã€‚
	ï¼ˆ3ï¼‰schemaPathï¼šå½“å‰ Schema çš„è·¯å¾„ï¼ˆç”¨äºè§£æè§†å›¾å†…éƒ¨çš„è¡¨ï¼‰ã€‚
	ï¼ˆ4ï¼‰viewPathï¼ˆå¯é€‰ï¼‰ï¼šè§†å›¾çš„è·¯å¾„ã€‚
è¿”å›å€¼
	RelRootï¼šå±•å¼€åçš„ RelNode åŠå…¶ç›¸å…³çš„æŸ¥è¯¢ä¿¡æ¯ã€‚


//====================================== ä½¿ç”¨åœºæ™¯
//====================================== ä½¿ç”¨åœºæ™¯

âœ…è§†å›¾å±•å¼€
ï¼ˆ1ï¼‰è§£æ CREATE VIEW my_view AS SELECT name, age FROM student
ï¼ˆ2ï¼‰expandView æ–¹æ³• è§£æ SQL å¹¶è¿”å› RelNodeï¼Œç”¨äºä¼˜åŒ–å’Œæ‰§è¡Œã€‚

âœ… åŠ¨æ€ SQL è§†å›¾è§£æ
ï¼ˆ1ï¼‰å…è®¸ç”¨æˆ·è‡ªå®šä¹‰è§†å›¾å±•å¼€é€»è¾‘ï¼Œä¾‹å¦‚æ›¿æ¢è§†å›¾æŸ¥è¯¢çš„å‚æ•°ï¼ŒåŠ¨æ€ä¿®æ”¹è§†å›¾å†…å®¹ã€‚
 
âœ… åˆ†å¸ƒå¼ SQL è§†å›¾è§£æ
ï¼ˆ1ï¼‰å¤„ç† è·¨æ•°æ®åº“çš„è§†å›¾ï¼Œæ¯”å¦‚åœ¨ Calcite è¿æ¥å¤šä¸ªæ•°æ®æºæ—¶ï¼Œè§£æ SQL è§†å›¾å¹¶è½¬æ¢åˆ° ä¸åŒçš„æ•°æ®æº æŸ¥è¯¢ã€‚
 
//====================================== ç¤ºä¾‹ï¼šè‡ªå®šä¹‰è§†å›¾å±•å¼€
//====================================== ç¤ºä¾‹ï¼šè‡ªå®šä¹‰è§†å›¾å±•å¼€
//ï¼ˆ1ï¼‰å‡è®¾æˆ‘ä»¬æœ‰ä¸ªè§†å›¾ï¼š
CREATE VIEW my_view AS SELECT name, age FROM student;

//ï¼ˆ2ï¼‰å¯ä»¥è¿™æ ·å®ç° ViewExpanderï¼š
public class MyViewExpander implements RelOptTable.ViewExpander {
    @Override
    public RelRoot expandView(RelDataType rowType, String queryString, 
                              List<String> schemaPath, @Nullable List<String> viewPath) {
        System.out.println("å±•å¼€è§†å›¾: " + queryString);

        // ä½¿ç”¨ SqlParser è§£æ SQL è§†å›¾
        SqlParser parser = SqlParser.create(queryString);
        SqlNode sqlNode = parser.parseQuery();

        // ä½¿ç”¨ SqlToRelConverter è½¬æ¢ SQL åˆ° RelNode
        RelOptCluster cluster = RelOptCluster.create(new VolcanoPlanner(), new RexBuilder(new JavaTypeFactoryImpl()));
        RelRoot relRoot = new SqlToRelConverter(this, null, null, cluster, null, null)
                .convertQuery(sqlNode, false, true);

        return relRoot;
    }
}
ğŸ“Œ è§£æ SQL â†’ è½¬æ¢ RelNode â†’ è¿”å› RelRootï¼Œè¿™æ ·å°±èƒ½åœ¨ SQL æ‰§è¡Œæ—¶è‡ªåŠ¨å±•å¼€è§†å›¾ï¼

//====================================== æ€»ç»“
//====================================== æ€»ç»“

ğŸ”¹ RelOptTable.ViewExpander ä¸»è¦ç”¨äº è§†å›¾å±•å¼€ï¼Œå°†è§†å›¾è½¬æ¢ä¸º RelNode è¿›è¡Œä¼˜åŒ–å’Œæ‰§è¡Œã€‚
ğŸ”¹ å…è®¸ è‡ªå®šä¹‰è§†å›¾è§£æé€»è¾‘ï¼Œæ¯”å¦‚ åŠ¨æ€ SQL è§£æã€è·¨æ•°æ®åº“è§†å›¾ã€å‚æ•°æ›¿æ¢ ç­‰ã€‚
ğŸ”¹ é€‚ç”¨äº Calcite SQL è§£æå’Œä¼˜åŒ–ï¼Œç¡®ä¿è§†å›¾èƒ½åƒæ™®é€š SQL è¯­å¥ä¸€æ ·ä½¿ç”¨ã€‚ ğŸš€