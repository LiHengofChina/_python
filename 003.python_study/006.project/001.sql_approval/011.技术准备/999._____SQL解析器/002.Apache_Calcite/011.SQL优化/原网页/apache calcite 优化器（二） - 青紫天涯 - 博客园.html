<!DOCTYPE html>
<!-- saved from url=(0048)https://www.cnblogs.com/wcgstudy/p/11795952.html -->
<html lang="zh-cn" style="--olcb-folder-code-block-max-height: 80vh; --cnb-code-bg: rgb(245, 245, 245); --cnb-code-font-size: 12px; --cnb-code-color: rgb(68, 68, 68);"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="never">
    
    <meta name="description" content="紧接上篇文章Apache Calcite 处理流程详解（一），这里是 Calcite 系列文章的第二篇，后面还会有文章讲述 Calcite 的实践（包括：如何开发用于 SQL 优化的 Rule）。本篇文章主要介绍 Apache Calcite 优化器部分的内容，会先简单介绍一下 RBO 和 CBO ">
    <meta property="og:description" content="紧接上篇文章Apache Calcite 处理流程详解（一），这里是 Calcite 系列文章的第二篇，后面还会有文章讲述 Calcite 的实践（包括：如何开发用于 SQL 优化的 Rule）。本篇文章主要介绍 Apache Calcite 优化器部分的内容，会先简单介绍一下 RBO 和 CBO ">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>apache calcite 优化器（二） - 青紫天涯 - 博客园</title>
    <link rel="icon" id="favicon" href="https://assets.cnblogs.com/favicon_v3_2.ico" type="image/x-icon">
    <link rel="canonical" href="https://www.cnblogs.com/wcgstudy/p/11795952.html">
    
    <style>#home :not(.cnblogs_code):not(.cnblogs_Highlighter)>pre:not([highlighted]):not([class*="brush:"]) code:not(.hljs), :not(.cnblogs_code):not(.cnblogs_Highlighter)>pre:not([highlighted]):not([class*="brush:"]) code:not(.hljs) {background: rgb(245, 245, 245);
        padding: 12px;
        border: 1px solid rgb(204, 204, 204);
        border-radius: 3px;
        border-color: transparent;
        color: rgb(68, 68, 68);
        font-family: "Courier New", sans-serif;
        font-size: 12px</style><link rel="stylesheet" href="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/blog-common.min.css">
    

    <link id="MainCss" rel="stylesheet" href="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/bundle-coffee.min.css">
        <link id="highlighter-theme-cnblogs" type="text/css" rel="stylesheet" href="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/cnblogs.css">
    
    
    <link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/bundle-coffee-mobile.min.css">
    
    <link type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/wcgstudy/rss">
    <link type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/wcgstudy/rsd.xml">
    <link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/wcgstudy/wlwmanifest.xml">
    
    <script type="text/javascript" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/encoder.js.下载"></script><script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "@id": "https://www.cnblogs.com/wcgstudy/p/11795952.html",
      "headline": "apache calcite 优化器（二）",
      "description": "紧接上篇文章Apache Calcite 处理流程详解（一），这里是 Calcite 系列文章的第二篇，后面还会有文章讲述 Calcite 的实践（包括：如何开发用于 SQL 优化的 Rule）。本篇文章主要介绍 Apache Calcite 优化器部分的内容，会先简单介绍一下 RBO 和 CBO ",
      "image": [
        
      ],
      "author": {
        "@type": "Person",
        "@id": "https://www.cnblogs.com/wcgstudy/",
        "name": "青紫天涯",
        "url": "https://www.cnblogs.com/wcgstudy/"
      },
      "publisher": {
        "@type": "Organization",
        "@id": "https://www.cnblogs.com/",
        "name": "博客园",
        "url": "https://www.cnblogs.com/"
      },
      "datePublished": "2019-11-05T00:37:00.0000000&#x2B;08:00",
      "dateModified": "2019-11-05T00:37:00.0000000&#x2B;08:00",
      "wordCount": "143672",
      "isPartOf": {
        "@type": "Blog",
        "@id": "https://www.cnblogs.com/wcgstudy/",
        "name": "青紫天涯",
        "publisher": {
          "@type": "Organization",
          "@id": "https://www.cnblogs.com/",
          "name": "博客园"
        }
      }
    }
    </script>

    <script>
        var currentBlogId = 494819;
        var currentBlogApp = 'wcgstudy';
        var isLogined = false;
        var isBlogOwner = false;
        var skinName = 'coffee';
        var visitorUserId = '';
        var hasCustomScript = false;
        window.cb_enable_mathjax = false;
        window.mathEngine = 0;
        window.codeHighlightEngine = 1;
        window.enableCodeLineNumber = false;
        window.codeHighlightTheme = 'cnblogs';
        window.darkModeCodeHighlightTheme = 'vs2015';
        window.isDarkCodeHighlightTheme = false;
        window.isDarkModeCodeHighlightThemeDark = true;
        window.isDisableCodeHighlighter = false;
        window.enableCodeThemeTypeFollowSystem = false;
        window.enableMacStyleCodeBlock = false;
    </script>
        <script>
            window.currentPostId = 11795952;
            window.currentPostDateAdded = '2019-11-05 00:37';
        </script>
    <script src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/jquery-3.3.1.min.js.下载"></script>
    <script src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/blog-common.min.js.下载"></script><style>.medium-zoom-overlay {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  opacity: 0;
  transition: opacity 300ms;
  will-change: opacity;
}

.medium-zoom--opened .medium-zoom-overlay {
  cursor: pointer;
  cursor: zoom-out;
  opacity: 1;
}

.medium-zoom-image {
  cursor: pointer;
  cursor: zoom-in;
  /*
    The `transition` is marked as "!important" for the animation to happen
    even though it's overriden by another inline `transition` style attribute.

    This is problematic with frameworks that generate inline styles on their
    images (e.g. Gatsby).

    See https://github.com/francoischalifour/medium-zoom/issues/110
   */
  transition: transform 300ms cubic-bezier(0.2, 0, 0.2, 1) !important;
}

.medium-zoom-image--hidden {
  visibility: hidden;
}

.medium-zoom-image--opened {
  position: relative;
  cursor: pointer;
  cursor: zoom-out;
  will-change: transform;
}
</style><script id="hljs-script" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/highlight.min.js.下载" type="text/javascript" async=""></script>
    
<meta property="og:image" content="https://matt33.com/images/calcite/6-filter-pushdown.png"></head>
<body class="skin-coffee has-navbar">
    <a name="top"></a>
        <div id="imagebar" class="imagebar-mobile imagebar-text-mobile formobile">
                <a href="https://www.doubao.com/?channel=cnblogs&amp;source=hw_db_cnblogs&amp;type=lunt&amp;theme=bianc" onclick="countCreativeClicks(&#39;M2-字节-豆包&#39;)" rel="nofollow">
                    <img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/35695-20241201073014811-1847930772.jpg" alt="" onload="countCreativeImpressionsOnMobile(&#39;M2-字节-豆包&#39;)">
                    <span id="m2_impression" style="display:none"></span>
                </a>
        </div>
    <div id="top_nav" class="navbar forpc">
        <nav id="nav_main" class="navbar-main">
            <ul id="nav_left" class="navbar-list navbar-left">
                <li class="navbar-branding">                    
                    <a href="https://www.cnblogs.com/" title="开发者的网上家园" role="banner">
                        <img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/logo.svg" alt="博客园logo">
                    </a>
                </li>
                    <li><a href="https://cnblogs.vip/">会员</a></li>
                    <li><a href="https://cnblogs.vip/store">T恤</a></li>
                <li>
                    <a href="https://news.cnblogs.com/" onclick="countClicks(&#39;nav&#39;, &#39;skin-navbar-news&#39;)">新闻</a>
                </li>
                <li>
                    <a href="https://q.cnblogs.com/" onclick="countClicks(&#39;nav&#39;, &#39;skin-navbar-q&#39;)">博问</a>
                </li>
                <li>
                    <a href="https://ing.cnblogs.com/" onclick="countClicks(&#39;nav&#39;, &#39;skin-navbar-ing&#39;)">闪存</a>
                </li>
                <li><a href="https://www.cnblogs.com/cmt/p/18341478">赞助商</a></li>
                <li><a href="https://chat2db-ai.com/" target="_blank" onclick="countClicks(&#39;nav&#39;, &#39;skin-navbar-chat2db&#39;)">Chat2DB</a></li>
            </ul>
            <ul id="nav_right" class="navbar-list navbar-right">
                <li>
                    <form id="zzk_search" class="navbar-search dropdown" action="https://zzk.cnblogs.com/s" method="get" role="search">
                        <input name="w" id="zzk_search_input" placeholder="代码改变世界" type="search" tabindex="3" autocomplete="off">
                        <button id="zzk_search_button" onclick="window.navbarSearchManager.triggerActiveOption()">
                            <img id="search_icon" class="focus-hidden" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/search.svg" alt="搜索">
                            <img class="hidden focus-visible" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/enter.svg" alt="搜索">
                        </button>
                        <ul id="navbar_search_options" class="dropdown-menu quick-search-menu">
                            <li tabindex="0" class="active" onclick="zzkSearch(event, document.getElementById(&#39;zzk_search_input&#39;).value)">
                                <div class="keyword-wrapper">
                                    <img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/search.svg" alt="搜索">
                                    <div class="keyword"></div>
                                </div>
                                <span class="search-area">所有博客</span>
                            </li>
                                    <li tabindex="1" onclick="zzkBlogSearch(event, &#39;wcgstudy&#39;, document.getElementById(&#39;zzk_search_input&#39;).value)">
                                        <div class="keyword-wrapper">
                                            <img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/search.svg" alt="搜索">
                                            <div class="keyword"></div>
                                        </div>
                                        <span class="search-area">当前博客</span>
                                    </li>
                        </ul>
                    </form>
                </li>
                <li id="navbar_login_status" class="navbar-list">
                    <a class="navbar-user-info navbar-blog" href="https://i.cnblogs.com/EditPosts.aspx?opt=1" alt="写随笔" title="写随笔" style="display: none;">
                        <img id="new_post_icon" class="navbar-icon" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/newpost.svg" alt="写随笔">
                    </a>
                    <a id="navblog-myblog-icon" class="navbar-user-info navbar-blog" href="https://passport.cnblogs.com/GetBlogApplyStatus.aspx" alt="我的博客" title="我的博客" style="display: none;">
                        <img id="myblog_icon" class="navbar-icon" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/myblog.svg" alt="我的博客">
                    </a>
                    <a class="navbar-user-info navbar-message navbar-icon-wrapper" href="https://msg.cnblogs.com/" alt="短消息" title="短消息" style="display: none;">
                        <img id="msg_icon" class="navbar-icon" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/message.svg" alt="短消息">
                        <span id="msg_count" style="display: none"></span>
                    </a>
                    <a id="navbar_lite_mode_indicator" data-current-page="blog" style="display: none" href="javascript:void(0)" alt="简洁模式" title="简洁模式启用，您在访问他人博客时会使用简洁款皮肤展示">
                        <img class="navbar-icon" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/lite-mode-on.svg" alt="简洁模式">
                    </a>
                    <div id="user_info" class="navbar-user-info dropdown" style="display: none;">
                        <a class="dropdown-button" href="https://home.cnblogs.com/">
                            <img id="user_icon" class="navbar-avatar" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/avatar-default.svg" alt="用户头像">
                        </a>
                        <div class="dropdown-menu">
                            <a id="navblog-myblog-text" href="https://passport.cnblogs.com/GetBlogApplyStatus.aspx">我的博客</a>
                            <a href="https://home.cnblogs.com/">我的园子</a>
                            <a href="https://account.cnblogs.com/settings/account">账号设置</a>
                            <a href="https://vip.cnblogs.com/my">会员中心</a>
                            <a href="javascript:void(0)" id="navbar_lite_mode_toggle" title="简洁模式会使用简洁款皮肤显示所有博客">
    简洁模式 <span id="navbar_lite_mode_spinner" class="hide">...</span>
</a>

                            <a href="javascript:void(0)" onclick="account.logout();">退出登录</a>
                        </div>
                    </div>
                    <a class="navbar-anonymous" href="https://account.cnblogs.com/signup" style="display: inline;">注册</a>
                    <a class="navbar-anonymous" href="javascript:void(0);" onclick="account.login()" style="display: inline;">登录</a>
                </li>
            </ul>
        </nav>
    </div>

    

    
<!--done-->
<div id="home">
<div id="header">
	<div id="blogTitle">
	<a href="https://www.cnblogs.com/wcgstudy/"><img id="blogLogo" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/logo.gif" alt="返回主页"></a>			
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle HeaderMainTitle" href="https://www.cnblogs.com/wcgstudy">青紫天涯</a>
</h1>
<h2></h2>




		
	</div><!--end: blogTitle 博客的标题和副标题 -->
</div><!--end: header 头部 -->

<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		<div id="navigator">
			
<ul id="navList">
	<li><a id="blog_nav_sitehome" class="menu" href="https://www.cnblogs.com/">
博客园</a>
</li>
	<li>
<a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/wcgstudy/">
首页</a>
</li>
	<li>

<a id="blog_nav_newpost" class="menu" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">
新随笔</a>
</li>
	<li>
<a id="blog_nav_contact" class="menu" href="https://msg.cnblogs.com/send/%E9%9D%92%E7%B4%AB%E5%A4%A9%E6%B6%AF">
联系</a></li>
	<li>
<a id="blog_nav_admin" class="menu" href="https://i.cnblogs.com/">
管理</a>
</li>
	<li>
<a id="blog_nav_rss" class="menu" href="javascript:void(0)" data-rss="https://www.cnblogs.com/wcgstudy/rss/">
订阅</a>
	
<a id="blog_nav_rss_image" href="https://www.cnblogs.com/wcgstudy/rss/">
    <img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/xml.gif" alt="订阅">
</a></li>
</ul>



			<div class="blogStats">
				
				<!--done-->
随笔- 65&nbsp;
文章- 1&nbsp;
评论- 6&nbsp;
阅读- 
<span title="总阅读数: 130121">
13万</span>&nbsp;



				
			</div><!--end: blogStats -->
		</div><!--end: navigator 博客导航栏 -->
		<div id="post_detail">
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wcgstudy/p/11795952.html" title="发布于 2019-11-05 00:37">
    <span role="heading" aria-level="2">apache calcite 优化器（二）</span>
    

</a><button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>紧接上篇文章<a href="http://matt33.com/2019/03/07/apache-calcite-process-flow/" rel="noopener nofollow">Apache Calcite 处理流程详解（一）</a>，这里是 Calcite 系列文章的第二篇，后面还会有文章讲述 Calcite 的实践（包括：如何开发用于 SQL 优化的 Rule）。本篇文章主要介绍 Apache Calcite 优化器部分的内容，会先简单介绍一下 RBO 和 CBO 模型，之后详细讲述 Calcite 关于这两个优化器的实现 —— HepPlanner 和 VolcanoPlanner，文章内容都是个人的一些理解，由于也是刚接触这块，理解有偏差的地方，欢迎指正。</p>
<h1 id="什么是查询优化器">什么是查询优化器<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h1>
<p>查询优化器是传统数据库的核心模块，也是大数据计算引擎的核心模块，开源大数据引擎如 Impala、Presto、Drill、HAWQ、 Spark、Hive 等都有自己的查询优化器。Calcite 就是从 Hive 的优化器演化而来的。</p>
<p>优化器的作用：将解析器生成的关系代数表达式转换成执行计划，供执行引擎执行，在这个过程中，会应用一些规则优化，以帮助生成更高效的执行计划。</p>
<blockquote>
<p>关于 Volcano 模型和 Cascades 模型的内容，建议看下相关的论文，这个是 Calcite 优化器的理论基础，代码只是把这个模型落地实现而已。</p>
</blockquote>
<h2 id="基于规则优化（RBO）">基于规则优化（RBO）<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>基于规则的优化器（Rule-Based Optimizer，RBO）：根据优化规则对关系表达式进行转换，这里的转换是说一个关系表达式经过优化规则后会变成另外一个关系表达式，同时原有表达式会被裁剪掉，经过一系列转换后生成最终的执行计划。</p>
<p>RBO 中包含了一套有着严格顺序的优化规则，同样一条 SQL，无论读取的表中数据是怎么样的，最后生成的执行计划都是一样的。同时，在 RBO 中 SQL 写法的不同很有可能影响最终的执行计划，从而影响执行计划的性能。</p>
<h2 id="基于成本优化（CBO）">基于成本优化（CBO）<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>基于代价的优化器(Cost-Based Optimizer，CBO)：根据优化规则对关系表达式进行转换，这里的转换是说一个关系表达式经过优化规则后会生成另外一个关系表达式，同时原有表达式也会保留，经过一系列转换后会生成多个执行计划，然后 CBO 会根据统计信息和代价模型 (Cost Model) 计算每个执行计划的 Cost，从中挑选 Cost 最小的执行计划。</p>
<p>由上可知，CBO 中有两个依赖：统计信息和代价模型。统计信息的准确与否、代价模型的合理与否都会影响 CBO 选择最优计划。 从上述描述可知，CBO 是优于 RBO 的，原因是 RBO 是一种只认规则，对数据不敏感的呆板的优化器，而在实际过程中，数据往往是有变化的，通过 RBO 生成的执行计划很有可能不是最优的。事实上目前各大数据库和大数据计算引擎都倾向于使用 CBO，但是对于流式计算引擎来说，使用 CBO 还是有很大难度的，因为并不能提前预知数据量等信息，这会极大地影响优化效果，CBO 主要还是应用在离线的场景。</p>
<h1 id="优化规则">优化规则<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h1>
<p>无论是 RBO，还是 CBO 都包含了一系列优化规则，这些优化规则可以对关系表达式进行等价转换，常见的优化规则包含：</p>
<ol>
<li>谓词下推 Predicate Pushdown</li>
<li>常量折叠 Constant Folding</li>
<li>列裁剪 Column Pruning</li>
<li>其他</li>
</ol>
<p>在 Calcite 的代码里，有一个测试类（<code>org.apache.calcite.test.RelOptRulesTest</code>）汇集了对目前内置所有 Rules 的测试 case，这个测试类可以方便我们了解各个 Rule 的作用。在这里有下面一条 SQL，通过这条语句来说明一下上面介绍的这三种规则。</p>
<p>&nbsp;&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">select</span> <span style="color: rgba(128, 0, 128, 1)">10</span> + <span style="color: rgba(128, 0, 128, 1)">30</span><span style="color: rgba(0, 0, 0, 1)">, users.name, users.age
</span><span style="color: rgba(0, 0, 255, 1)">from</span> users join jobs on users.id=<span style="color: rgba(0, 0, 0, 1)"> user.id
</span><span style="color: rgba(0, 0, 255, 1)">where</span> users.age &gt; <span style="color: rgba(128, 0, 128, 1)">30</span> and jobs.id&gt;<span style="color: rgba(128, 0, 128, 1)">10</span></pre>
</div>
<h2 id="谓词下推（Predicate-Pushdown）">谓词下推（Predicate Pushdown）<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>关于谓词下推，它主要还是从关系型数据库借鉴而来，关系型数据中将谓词下推到外部数据库用以减少数据传输；属于逻辑优化，优化器将谓词过滤下推到数据源，使物理执行跳过无关数据。最常见的例子就是 join 与 filter 操作一起出现时，提前执行 filter 操作以减少处理的数据量，将 filter 操作下推，以上面例子为例，示意图如下（对应 Calcite 中的 <code>FilterJoinRule.FilterIntoJoinRule.FILTER_ON_JOIN</code> Rule）：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/6-filter-pushdown.png" alt="" width="1000" height="499" class="medium-zoom-image"></p>
<p>&nbsp;</p>
<p>在进行 join 前进行相应的过滤操作，可以极大地减少参加 join 的数据量。</p>
<h2 id="常量折叠（Constant-Folding）">常量折叠（Constant Folding）<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>常量折叠也是常见的优化策略，这个比较简单、也很好理解，可以看下 <a href="http://blog.caoxudong.info/blog/2013/10/23/compiler_optimizations_constant_folding" rel="noopener nofollow" target="_blank">编译器优化 – 常量折叠</a> 这篇文章，基本不用动脑筋就能理解，对于我们这里的示例，有一个常量表达式 <code>10 + 30</code>，如果不进行常量折叠，那么每行数据都需要进行计算，进行常量折叠后的结果如下图所示（ 对应 Calcite 中的 <code>ReduceExpressionsRule.PROJECT_INSTANCE</code> Rule）：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/7-constant.png" alt="" width="1000" height="486" class="medium-zoom-image"></p>
<h2 id="列裁剪（Column-Pruning）">列裁剪（Column Pruning）<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>列裁剪也是一个经典的优化规则，在本示例中对于jobs 表来说，并不需要扫描它的所有列值，而只需要列值 id，所以在扫描 jobs 之后需要将其他列进行裁剪，只留下列 id。这个优化带来的好处很明显，大幅度减少了网络 IO、内存数据量的消耗。裁剪前后的示意图如下（不过并没有找到 Calcite 对应的 Rule）：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/8-pruning.png" alt="" width="1000" class="medium-zoom-image"></p>
<h1 id="Calcite-中的优化器实现">Calcite 中的优化器实现<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h1>
<p>有了前面的基础后，这里来看下 Calcite 中优化器的实现，RelOptPlanner 是 Calcite 中优化器的基类，其子类实现如下图所示：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/9-RelOptPlanner.png" alt="" width="1008" height="444" class="medium-zoom-image"></p>
<p>Calcite 中关于优化器提供了两种实现：</p>
<ol>
<li>HepPlanner：就是前面 RBO 的实现，它是一个启发式的优化器，按照规则进行匹配，直到达到次数限制（match 次数限制）或者遍历一遍后不再出现 rule match 的情况才算完成；</li>
<li>VolcanoPlanner：就是前面 CBO 的实现，它会一直迭代 rules，直到找到 cost 最小的 paln。</li>
</ol>
<blockquote>
<p>前面提到过像calcite这类查询优化器最核心的两个问题之一是怎么把优化规则应用到关系代数相关的RelNode Tree上。所以在阅读calicite的代码时就得带着这个问题去看看它的实现过程，然后才能判断它的代码实现得是否优雅。<br>calcite的每种规则实现类(RelOptRule的子类)都会声明自己应用在哪种RelNode子类上，每个RelNode子类其实都可以看成是一种operator(中文常翻译成算子)。<br>VolcanoPlanner就是优化器，用的是动态规划算法，在创建VolcanoPlanner的实例后，通过calcite的标准jdbc接口执行sql时，默认会给这个VolcanoPlanner的实例注册将近90条优化规则(还不算常量折叠这种最常见的优化)，所以看代码时，知道什么时候注册可用的优化规则是第一步(调用VolcanoPlanner.addRule实现)，这一步比较简单。<br>接下来就是如何筛选规则了，当把语法树转成RelNode
 Tree后是没有必要把前面注册的90条优化规则都用上的，所以需要有个筛选的过程，因为每种规则是有应用范围的，按RelNode 
Tree的不同节点类型就可以筛选出实际需要用到的优化规则了。这一步说起来很简单，但在calcite的代码实现里是相当复杂的，也是非常关键的一步，是从调用VolcanoPlanner.setRoot方法开始间接触发的，如果只是静态的看代码不跑起来跟踪调试多半摸不清它的核心流程的。筛选出来的优化规则会封装成VolcanoRuleMatch，然后扔到RuleQueue里，而这个RuleQueue正是接下来执行动态规划算法要用到的核心类。筛选规则这一步的代码实现很晦涩。<br>第三步才到VolcanoPlanner.findBestExp，本质上就是一个动态规划算法的实现，但是最值得关注的还是怎么用第二步筛选出来的规则对RelNode
 Tree进行变换，变换后的形式还是一棵RelNode 
Tree，最常见的是把LogicalXXX开头的RelNode子类换成了EnumerableXXX或BindableXXX，总而言之，看看具体优化规则的实现就对了，都是繁琐的体力活。<br>一个优化器，理解了上面所说的三步基本上就抓住重点了。<br>—— 来自【zhh-4096 】的微博</p>


</blockquote>
<p>下面详细讲述一下这两种 planner 在 Calcite 内部的具体实现。</p>
<h2 id="HepPlanner">HepPlanner<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>使用 HepPlanner 实现的完整代码见 <a href="https://github.com/wangzzu/program-example/blob/master/calcite-example/src/main/java/com/matt/test/calcite/sql/SqlHepTest.java" rel="noopener nofollow" target="_blank">SqlHepTest</a>。</p>
<h3 id="HepPlanner-中的基本概念">HepPlanner 中的基本概念<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>这里先看下 HepPlanner 的一些基本概念，对于后面的理解很有帮助。</p>
<h4 id="HepRelVertex">HepRelVertex<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>HepRelVertex 是对 RelNode 进行了简单封装。HepPlanner 中的所有节点都是 HepRelVertex，每个 HepRelVertex 都指向了一个真正的 RelNode 节点。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> org.apache.calcite.plan.hep.HepRelVertex</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * HepRelVertex wraps a real {@link RelNode} as a vertex in a DAG representing
 * the entire query expression.
 * note：HepRelVertex 将一个 RelNode 封装为一个 DAG 中的 vertex（DAG 代表整个 query expression）
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> HepRelVertex extends AbstractRelNode {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">~ Instance fields --------------------------------------------------------</span>

  <span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Wrapped rel currently chosen for implementation of expression.
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
  <span style="color: rgba(0, 0, 255, 1)">private</span><span style="color: rgba(0, 0, 0, 1)"> RelNode currentRel;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<h4 id="HepInstruction">HepInstruction<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>HepInstruction 是 HepPlanner 对一些内容的封装，具体的子类实现比较多，其中 RuleInstance 是 HepPlanner 中对 Rule 的一个封装，注册的 Rule 最后都会转换为这种形式。</p>
<blockquote>
<p>HepInstruction represents one instruction in a HepProgram.</p>
<p>&nbsp;</p>
</blockquote>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.hep.HepInstruction</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">* Instruction that executes a given rule. </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 执行指定 rule 的 Instruction</span>
<span style="color: rgba(0, 0, 255, 1)">static</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> RuleInstance extends HepInstruction {
  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Description to look for, or null if rule specified explicitly.
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  String ruleDescription;

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Explicitly specified rule, or rule looked up by planner from
   * description.
   * note：设置其 Rule
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  RelOptRule rule;

  </span><span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> initialize(boolean clearCache) {
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">clearCache) {
      </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
    }

    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (ruleDescription != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Look up anew each run.</span>
      rule = <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">;
    }
  }

  </span><span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> execute(HepPlanner planner) {
    planner.executeInstruction(</span><span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">);
  }
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<h3 id="HepPlanner-处理流程">HepPlanner 处理流程<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>下面这个示例是上篇文章（<a href="http://matt33.com/2019/03/07/apache-calcite-process-flow/" rel="noopener nofollow">Apache Calcite 处理流程详解（一）</a>）的示例，通过这段代码来看下 HepPlanner 的内部实现机制。</p>
<div class="cnblogs_code">
<pre>HepProgramBuilder builder = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> HepProgramBuilder();
builder.addRuleInstance(FilterJoinRule.FilterIntoJoinRule.FILTER_ON_JOIN); </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 添加 rule</span>
HepPlanner hepPlanner = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> HepPlanner(builder.build());
hepPlanner.setRoot(relNode);
relNode </span>= hepPlanner.findBestExp();</pre>
</div>
<p>上面的代码总共分为三步：</p>
<ol>
<li>初始化 HepProgram 对象；</li>
<li>初始化 HepPlanner 对象，并通过 <code>setRoot()</code> 方法将 RelNode 树转换成 HepPlanner 内部使用的 Graph；</li>
<li>通过 <code>findBestExp()</code> 找到最优的 plan，规则的匹配都是在这里进行。</li>
</ol>
<h4 id="1-初始化-HepProgram">1. 初始化 HepProgram<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>这几步代码实现没有太多需要介绍的地方，先初始化 HepProgramBuilder 也是为了后面初始化 HepProgram 做准备，HepProgramBuilder 主要也就是提供了一些配置设置和添加规则的方法等，常用的方法如下：</p>
<ol>
<li><code>addRuleInstance()</code>：注册相应的规则；</li>
<li><code>addRuleCollection()</code>：这里是注册一个规则集合，先把规则放在一个集合里，再注册整个集合，如果规则多的话，一般是这种方式；</li>
<li><code>addMatchLimit()</code>：设置 MatchLimit，这个 rule match 次数的最大限制；</li>
</ol>
<p>HepProgram 这个类对于后面 HepPlanner 的优化很重要，它定义 Rule 匹配的顺序，默认按【深度优先】顺序，它可以提供以下几种（见 HepMatchOrder 类）：</p>
<ol>
<li><strong>ARBITRARY</strong>：按任意顺序匹配（因为它是有效的，而且大部分的 Rule 并不关心匹配顺序）；</li>
<li><strong>BOTTOM_UP</strong>：自下而上，先从子节点开始匹配；</li>
<li><strong>TOP_DOWN</strong>：自上而下，先从父节点开始匹配；</li>
<li><strong>DEPTH_FIRST</strong>：深度优先匹配，某些情况下比 ARBITRARY 高效（为了避免新的 vertex 产生后又从 root 节点开始匹配）。</li>
</ol>
<p>这个匹配顺序到底是什么呢？对于规则集合 rules，HepPlanner 的算法是：从一个节点开始，跟 rules 的所有 Rule 进行匹配，匹配上就进行转换操作，这个节点操作完，再进行下一个节点，这里的匹配顺序就是指的<strong>节点遍历顺序</strong>（这种方式的优劣，我们下面再说）。</p>
<h4 id="2-HepPlanner-setRoot（RelNode-–-gt-Graph）">2. HepPlanner.setRoot（RelNode –&gt; Graph）<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>先看下 <code>setRoot()</code> 方法的实现：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> org.apache.calcite.plan.hep.HepPlanner</span>
<span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> setRoot(RelNode rel) {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 将 RelNode 转换为 DAG 表示</span>
  root =<span style="color: rgba(0, 0, 0, 1)"> addRelToGraph(rel);
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 仅仅是在 trace 日志中输出 Graph 信息</span>
<span style="color: rgba(0, 0, 0, 1)">  dumpGraph();
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>HepPlanner 会先将所有 relNode tree 转化为 HepRelVertex，这时就构建了一个 Graph：将所有的 elNode 节点使用 Vertex 表示，Gragh 会记录每个 HepRelVertex 的 input 信息，这样就是构成了一张 graph。</p>
<p>在真正的实现时，递归逐渐将每个 relNode 转换为 HepRelVertex，并在 <code>graph</code> 中记录相关的信息，实现如下：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.hep.HepPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 根据 RelNode 构建一个 Graph</span>
<span style="color: rgba(0, 0, 255, 1)">private</span><span style="color: rgba(0, 0, 0, 1)"> HepRelVertex addRelToGraph(
    RelNode rel) {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Check if a transformation already produced a reference
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> to an existing vertex.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 检查这个 rel 是否在 graph 中转换了</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (graph.vertexSet().contains(rel)) {
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> (HepRelVertex) rel;
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Recursively add children, replacing this rel's inputs
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> with corresponding child vertices.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 递归地增加子节点，使用子节点相关的 vertices 代替 rel 的 input</span>
  final List&lt;RelNode&gt; inputs =<span style="color: rgba(0, 0, 0, 1)"> rel.getInputs();
  final List</span>&lt;RelNode&gt; newInputs = <span style="color: rgba(0, 0, 255, 1)">new</span> ArrayList&lt;&gt;<span style="color: rgba(0, 0, 0, 1)">();
  </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (RelNode input1 : inputs) {
    HepRelVertex childVertex </span>= addRelToGraph(input1); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 递归进行转换</span>
    newInputs.add(childVertex); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 每个 HepRelVertex 只记录其 Input</span>
<span style="color: rgba(0, 0, 0, 1)">  }

  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (!Util.equalShallow(inputs, newInputs)) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 不相等的情况下</span>
    RelNode oldRel =<span style="color: rgba(0, 0, 0, 1)"> rel;
    rel </span>=<span style="color: rgba(0, 0, 0, 1)"> rel.copy(rel.getTraitSet(), newInputs);
    onCopy(oldRel, rel);
  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Compute digest first time we add to DAG,
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> otherwise can't get equivVertex for common sub-expression
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 计算 relNode 的 digest
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: Digest 的意思是：
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: A short description of this relational expression's type, inputs, and
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: other properties. The string uniquely identifies the node; another node
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: is equivalent if and only if it has the same value.</span>
<span style="color: rgba(0, 0, 0, 1)">  rel.recomputeDigest();

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> try to find equivalent rel only if DAG is allowed
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果允许 DAG 的话，检查是否有一个等价的 HepRelVertex，有的话直接返回</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">noDag) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Now, check if an equivalent vertex already exists in graph.</span>
    String digest =<span style="color: rgba(0, 0, 0, 1)"> rel.getDigest();
    HepRelVertex equivVertex </span>= mapDigestToVertex.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(digest);
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (equivVertex != <span style="color: rgba(0, 0, 255, 1)">null</span>) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 已经存在
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Use existing vertex.</span>
      <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> equivVertex;
    }
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> No equivalence:  create a new vertex to represent this rel.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 创建一个 vertex 代替 rel</span>
  HepRelVertex newVertex = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> HepRelVertex(rel);
  graph.addVertex(newVertex); </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 记录 Vertex</span>
  updateVertex(newVertex, rel);<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 更新相关的缓存，比如 mapDigestToVertex map</span>

  <span style="color: rgba(0, 0, 255, 1)">for</span> (RelNode input : rel.getInputs()) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 设置 Edge</span>
    graph.addEdge(newVertex, (HepRelVertex) input);<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 记录与整个 Vertex 先关的 input</span>
<span style="color: rgba(0, 0, 0, 1)">  }

  nTransformations</span>++<span style="color: rgba(0, 0, 0, 1)">;
  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> newVertex;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>到这里 HepPlanner 需要的 gragh 已经构建完成，通过 DEBUG 方式也能看到此时 HepPlanner root 变量的内容：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/10-calcite.png" alt="" width="1034" height="501" class="medium-zoom-image"></p>
<h4 id="3-HepPlanner-findBestExp-规则优化">3. HepPlanner findBestExp 规则优化<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.hep.HepPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> implement RelOptPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 优化器的核心，匹配规则进行优化</span>
<span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> RelNode findBestExp() {
  assert root </span>!= <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">;

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 运行 HepProgram 算法(按 HepProgram 中的 instructions 进行相应的优化)</span>
<span style="color: rgba(0, 0, 0, 1)">  executeProgram(mainProgram);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Get rid of everything except what's in the final plan.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 垃圾收集</span>
<span style="color: rgba(0, 0, 0, 1)">  collectGarbage();

  </span><span style="color: rgba(0, 0, 255, 1)">return</span> buildFinalPlan(root); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 返回最后的结果，还是以 RelNode 表示</span>
}</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>主要的实现是在 <code>executeProgram()</code> 方法中，如下：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.hep.HepPlanner</span>
<span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> executeProgram(HepProgram program) {
  HepProgram savedProgram </span>= currentProgram; <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 保留当前的 Program</span>
  currentProgram =<span style="color: rgba(0, 0, 0, 1)"> program;
  currentProgram.initialize(program </span>== mainProgram);<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果是在同一个 Program 的话，保留上次 cache</span>
  <span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (HepInstruction instruction : currentProgram.instructions) {
    instruction.execute(</span><span style="color: rgba(0, 0, 255, 1)">this</span>); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 按 Rule 进行优化(会调用 executeInstruction 方法)</span>
    <span style="color: rgba(0, 0, 255, 1)">int</span> delta = nTransformations -<span style="color: rgba(0, 0, 0, 1)"> nTransformationsLastGC;
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (delta &gt;<span style="color: rgba(0, 0, 0, 1)"> graphSizeLastGC) {
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> The number of transformations performed since the last
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> garbage collection is greater than the number of vertices in
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> the graph at that time.  That means there should be a
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> reasonable amount of garbage to collect now.  We do it this
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> way to amortize garbage collection cost over multiple
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> instructions, while keeping the highwater memory usage
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> proportional to the graph size.
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 进行转换的次数已经大于 DAG Graph 中的顶点数，这就意味着已经产生大量垃圾需要进行清理</span>
<span style="color: rgba(0, 0, 0, 1)">      collectGarbage();
    }
  }
  currentProgram </span>=<span style="color: rgba(0, 0, 0, 1)"> savedProgram;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>这里会遍历 HepProgram 中 instructions（记录注册的所有 HepInstruction），然后根据 instruction 的类型执行相应的 <code>executeInstruction()</code> 方法，如果instruction 是 <code>HepInstruction.MatchLimit</code> 类型，会执行 <code>executeInstruction(HepInstruction.MatchLimit instruction)</code> 方法，这个方法就是初始化 matchLimit 变量。对于 <code>HepInstruction.RuleInstance</code> 类型的 instruction 会执行下面的方法（前面的示例注册规则使用的是 <code>addRuleInstance()</code> 方法，所以返回的 rules 只有一个规则，如果注册规则的时候使用的是 <code>addRuleCollection()</code> 方法注册一个规则集合的话，这里会返回的 rules 就是那个规则集合）：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.hep.HepPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 执行相应的 RuleInstance</span>
<span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> executeInstruction(
    HepInstruction.RuleInstance instruction) {
  </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (skippingGroup()) {
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
  }
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (instruction.rule == <span style="color: rgba(0, 0, 255, 1)">null</span>) {<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果 rule 为 null，那么就按照 description 查找具体的 rule</span>
    assert instruction.ruleDescription != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">;
    instruction.rule </span>=<span style="color: rgba(0, 0, 0, 1)">
        getRuleByDescription(instruction.ruleDescription);
    LOGGER.trace(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Looking up rule with description {}, found {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
        instruction.ruleDescription, instruction.rule);
  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 执行相应的 rule</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (instruction.rule != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    applyRules(
        Collections.singleton(instruction.rule),
        </span><span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">);
  }
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>接下来看 <code>applyRules()</code> 的实现：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.hep.HepPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 执行 rule（forceConversions 默认 true）</span>
<span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> applyRules(
    Collection</span>&lt;RelOptRule&gt;<span style="color: rgba(0, 0, 0, 1)"> rules,
    boolean forceConversions) {
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (currentProgram.group != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    assert currentProgram.group.collecting;
    currentProgram.group.ruleSet.addAll(rules);
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
  }

  LOGGER.trace(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Applying rule set {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, rules);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 当遍历规则是 ARBITRARY 或 DEPTH_FIRST 时，设置为 false，此时不会从 root 节点开始，否则每次 restart 都从 root 节点开始</span>
  boolean fullRestartAfterTransformation =<span style="color: rgba(0, 0, 0, 1)">
      currentProgram.matchOrder </span>!=<span style="color: rgba(0, 0, 0, 1)"> HepMatchOrder.ARBITRARY
      </span>&amp;&amp; currentProgram.matchOrder !=<span style="color: rgba(0, 0, 0, 1)"> HepMatchOrder.DEPTH_FIRST;

  </span><span style="color: rgba(0, 0, 255, 1)">int</span> nMatches = <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;

  boolean fixedPoint;
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 两种情况会跳出循环，一种是达到 matchLimit 限制，一种是遍历一遍不会再有新的 transform 产生</span>
  <span style="color: rgba(0, 0, 255, 1)">do</span><span style="color: rgba(0, 0, 0, 1)"> {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 按照遍历规则获取迭代器</span>
    Iterator&lt;HepRelVertex&gt; iter =<span style="color: rgba(0, 0, 0, 1)"> getGraphIterator(root);
    fixedPoint </span>= <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">while</span><span style="color: rgba(0, 0, 0, 1)"> (iter.hasNext()) {
      HepRelVertex vertex </span>= iter.next();<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 遍历每个 HepRelVertex</span>
      <span style="color: rgba(0, 0, 255, 1)">for</span> (RelOptRule rule : rules) {<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 遍历每个 rules
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 进行规制匹配，也是真正进行相关操作的地方</span>
        HepRelVertex newVertex =<span style="color: rgba(0, 0, 0, 1)">
            applyRule(rule, vertex, forceConversions);
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> (newVertex == <span style="color: rgba(0, 0, 255, 1)">null</span> || newVertex ==<span style="color: rgba(0, 0, 0, 1)"> vertex) {
          </span><span style="color: rgba(0, 0, 255, 1)">continue</span><span style="color: rgba(0, 0, 0, 1)">;
        }
        </span>++<span style="color: rgba(0, 0, 0, 1)">nMatches;
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 超过 MatchLimit 的限制</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span> (nMatches &gt;=<span style="color: rgba(0, 0, 0, 1)"> currentProgram.matchLimit) {
          </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
        }
        </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (fullRestartAfterTransformation) {
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 发生 transformation 后，从 root 节点再次开始</span>
          iter =<span style="color: rgba(0, 0, 0, 1)"> getGraphIterator(root);
        } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> To the extent possible, pick up where we left
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> off; have to create a new iterator because old
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> one was invalidated by transformation.
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 尽可能从上次进行后的节点开始</span>
          iter =<span style="color: rgba(0, 0, 0, 1)"> getGraphIterator(newVertex);
          </span><span style="color: rgba(0, 0, 255, 1)">if</span> (currentProgram.matchOrder ==<span style="color: rgba(0, 0, 0, 1)"> HepMatchOrder.DEPTH_FIRST) {
            </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 这样做的原因就是为了防止有些 HepRelVertex 遗漏了 rule 的匹配（每次从 root 开始是最简单的算法），因为可能出现下推</span>
            nMatches =<span style="color: rgba(0, 0, 0, 1)">
                depthFirstApply(iter, rules, forceConversions, nMatches);
            </span><span style="color: rgba(0, 0, 255, 1)">if</span> (nMatches &gt;=<span style="color: rgba(0, 0, 0, 1)"> currentProgram.matchLimit) {
              </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
            }
          }
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Remember to go around again since we're
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> skipping some stuff.
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 再来一遍，因为前面有跳过一些节点</span>
          fixedPoint = <span style="color: rgba(0, 0, 255, 1)">false</span><span style="color: rgba(0, 0, 0, 1)">;
        }
        </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
      }
    }
  } </span><span style="color: rgba(0, 0, 255, 1)">while</span> (!<span style="color: rgba(0, 0, 0, 1)">fixedPoint);
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>在这里会调用 <code>getGraphIterator()</code> 方法获取 HepRelVertex 的迭代器，迭代的策略（遍历的策略）跟前面说的顺序有关，默认使用的是【深度优先】，这段代码比较简单，就是遍历规则+遍历节点进行匹配转换，直到满足条件再退出，从这里也能看到 HepPlanner 的实现效率不是很高，它也无法保证能找出最优的结果。</p>
<p>总结一下，HepPlanner 在优化过程中，是先遍历规则，然后再对每个节点进行匹配转换，直到满足条件（超过限制次数或者规则遍历完一遍不会再有新的变化），其方法调用流程如下：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/11-hep.png" alt="" width="1000" class="medium-zoom-image"></p>
<h3 id="思考">思考<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<h4 id="1-为什么要把-RelNode-转换-HepRelVertex-进行优化？带来的收益在哪里？">1. 为什么要把 RelNode 转换 HepRelVertex 进行优化？带来的收益在哪里？<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>关于这个，能想到的就是：RelNode 是底层提供的抽象、偏底层一些，在优化器这一层，需要记录更多的信息，所以又做了一层封装。</p>
<h2 id="VolcanoPlanner">VolcanoPlanner<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h2>
<p>介绍完 HepPlanner 之后，接下来再来看下基于成本优化（CBO）模型在 Calcite 中是如何实现、如何落地的，关于 Volcano 理论内容建议先看下相关理论知识，否则直接看实现的话可能会有一些头大。从 Volcano 模型的理论落地到实践是有很大区别的，这里先看一张 VolcanoPlanner 整体实现图，如下所示（图片来自 <a href="https://www.slideshare.net/julianhyde/costbased-query-optimization-in-apache-phoenix-using-apache-calcite?qid=b7a1ca0f-e7bf-49ad-bc51-0615ec8a4971&amp;v=&amp;b=&amp;from_search=4" rel="noopener nofollow" target="_blank">Cost-based Query Optimization in Apache Phoenix using Apache Calcite</a>）：</p>
<p><a class="fancybox" title="Calcite VolcanoPlanner Process" href="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/12-VolcanoPlanner.png" rel="noopener nofollow"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/12-VolcanoPlanner.png" alt="Calcite VolcanoPlanner Process" width="1000"></a></p>
<p>上面基本展现了 VolcanoPlanner 内部实现的流程，也简单介绍了 VolcanoPlanner 在实现中的一些关键点（有些概念暂时不了解也不要紧，后面会介绍）：</p>
<ol>
<li>Add Rule matches to Queue：向 Rule Match Queue 中添加相应的 Rule Match；</li>
<li>Apply Rule match transformations to plan gragh：应用 Rule Match 对 plan graph 做 transformation 优化（Rule specifies an Operator sub-graph to match and logic to generate equivalent better sub-graph）；</li>
<li>Iterate for fixed iterations or until cost doesn’t change：进行相应的迭代，直到 cost 不再变化或者 Rule Match Queue 中 rule match 已经全部应用完成；</li>
<li>Match importance based on cost of RelNode and height：Rule Match 的 importance 依赖于 RelNode 的 cost 和深度。</li>
</ol>
<p>使用 VolcanoPlanner 实现的完整代码见 <a href="https://github.com/wangzzu/program-example/blob/master/calcite-example/src/main/java/com/matt/test/calcite/sql/SqlVolcanoTest.java" rel="noopener nofollow" target="_blank">SqlVolcanoTest</a>。</p>
<p>下面来看下 VolcanoPlanner 实现具体的细节。</p>
<h3 id="VolcanoPlanner-中的基本概念">VolcanoPlanner 中的基本概念<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>VolcanoPlanner 在实现中引入了一些基本概念，先明白这些概念对于理解 VolcanoPlanner 的实现非常有帮助。</p>
<h4 id="RelSet">RelSet<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>关于 RelSet，源码中介绍如下：</p>
<blockquote>
<p>RelSet is an equivalence-set of expressions that is, a set of expressions which have <strong>identical semantics</strong>.<br>We are generally interested in using the expression which has <strong>the lowest cost</strong>.<br>All of the expressions in an RelSet have the <strong>same calling convention</strong>.</p>


</blockquote>
<p>它有以下特点：</p>
<ol>
<li>描述一组等价 Relation Expression，所有的 RelNode 会记录在 <code>rels</code> 中；</li>
<li>have the same calling convention；</li>
<li>具有相同物理属性的 Relational Expression 会记录在其成员变量 <code>List&lt;RelSubset&gt; subsets</code> 中.</li>

</ol>
<p>RelSet 中比较重要成员变量如下：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> RelSet {
   </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 记录属于这个 RelSet 的所有 RelNode</span>
  final List&lt;RelNode&gt; rels = <span style="color: rgba(0, 0, 255, 1)">new</span> ArrayList&lt;&gt;<span style="color: rgba(0, 0, 0, 1)">();
  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Relational expressions that have a subset in this set as a child. This
   * is a multi-set. If multiple relational expressions in this set have the
   * same parent, there will be multiple entries.
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  final List</span>&lt;RelNode&gt; parents = <span style="color: rgba(0, 0, 255, 1)">new</span> ArrayList&lt;&gt;<span style="color: rgba(0, 0, 0, 1)">();
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 具体相同物理属性的子集合（本质上 RelSubset 并不记录 RelNode，也是通过 RelSet 按物理属性过滤得到其 RelNode 子集合，见下面的 RelSubset 部分）</span>
  final List&lt;RelSubset&gt; subsets = <span style="color: rgba(0, 0, 255, 1)">new</span> ArrayList&lt;&gt;<span style="color: rgba(0, 0, 0, 1)">();

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * List of {@link AbstractConverter} objects which have not yet been
   * satisfied.
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  final List</span>&lt;AbstractConverter&gt; abstractConverters = <span style="color: rgba(0, 0, 255, 1)">new</span> ArrayList&lt;&gt;<span style="color: rgba(0, 0, 0, 1)">();

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Set to the superseding set when this is found to be equivalent to another
   * set.
   * note：当发现与另一个 RelSet 有相同的语义时，设置为替代集合
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  RelSet equivalentSet;
  RelNode rel;

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Variables that are set by relational expressions in this set and available for use by parent and child expressions.
   * note：在这个集合中 relational expression 设置的变量，父类和子类 expression 可用的变量
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  final Set</span>&lt;CorrelationId&gt;<span style="color: rgba(0, 0, 0, 1)"> variablesPropagated;

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Variables that are used by relational expressions in this set.
   * note：在这个集合中被 relational expression 使用的变量
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  final Set</span>&lt;CorrelationId&gt;<span style="color: rgba(0, 0, 0, 1)"> variablesUsed;
  final </span><span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)"> id;

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Reentrancy flag.
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  boolean inMetadataQuery;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<h4 id="RelSubset">RelSubset<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>关于 RelSubset，源码中介绍如下：</p>
<blockquote>
<p>Subset of an equivalence class where all relational expressions have the same physical properties.</p>
</blockquote>
<p>它的特点如下：</p>
<ol>
<li>描述一组物理属性相同的等价 Relation Expression，即它们具有相同的 Physical Properties；</li>
<li>每个 RelSubset 都会记录其所属的 RelSet；</li>
<li>RelSubset 继承自 AbstractRelNode，它也是一种 RelNode，物理属性记录在其成员变量 traitSet 中。</li>
</ol>
<p>RelSubset 一些比较重要的成员变量如下：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> RelSubset extends AbstractRelNode {
  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * cost of best known plan (it may have improved since)
   * note: 已知最佳 plan 的 cost
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  RelOptCost bestCost;

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * The set this subset belongs to.
   * RelSubset 所属的 RelSet，在 RelSubset 中并不记录具体的 RelNode，直接记录在 RelSet 的 rels 中
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  final RelSet </span><span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">;

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * best known plan
   * note: 已知的最佳 plan
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  RelNode best;

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Flag indicating whether this RelSubset's importance was artificially
   * boosted.
   * note: 标志这个 RelSubset 的 importance 是否是人为地提高了
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
  boolean boosted;

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">~ Constructors -----------------------------------------------------------</span>
<span style="color: rgba(0, 0, 0, 1)">  RelSubset(
      RelOptCluster cluster,
      RelSet </span><span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">,
      RelTraitSet traits) {
    super(cluster, traits); </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 继承自 AbstractRelNode，会记录其相应的 traits 信息</span>
    <span style="color: rgba(0, 0, 255, 1)">this</span>.<span style="color: rgba(0, 0, 255, 1)">set</span> = <span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">this</span>.boosted = <span style="color: rgba(0, 0, 255, 1)">false</span><span style="color: rgba(0, 0, 0, 1)">;
    assert traits.allSimple();
    computeBestCost(cluster.getPlanner()); </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 计算 best</span>
    recomputeDigest(); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 计算 digest</span>
<span style="color: rgba(0, 0, 0, 1)">  }
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>每个 RelSubset 都将会记录其最佳 plan（<code>best</code>）和最佳 plan 的 cost（<code>bestCost</code>）信息。</p>
<h4 id="RuleMatch">RuleMatch<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>RuleMatch 是这里对 Rule 和 RelSubset 关系的一个抽象，它会记录这两者的信息。</p>
<blockquote>
<p>A match of a rule to a particular set of target relational expressions, frozen in time.</p>
</blockquote>
<h4 id="importance">importance<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>importance 决定了在进行 Rule 优化时 Rule 应用的顺序，它是一个相对概念，在 VolcanoPlanner 中有两个 importance，分别是 RelSubset 和 RuleMatch 的 importance，这里先提前介绍一下。</p>
<h5 id="RelSubset-的-importance">RelSubset 的 importance<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h5>
<p>RelSubset importance 计算方法见其 api 定义（<strong>图中的 sum 改成 Math.max{}</strong>这个地方有误）：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/13-compute.png" alt="" width="1000" class="medium-zoom-image"></p>
<p>举个例子：假设一个 RelSubset（记为 <span id="MathJax-Element-1-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-1" class="mjx-math"><span id="MJXc-Node-2" class="mjx-mrow"><span id="MJXc-Node-3" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-4" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-5" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">0） 的 cost 是3，对应的 importance 是0.5，这个 RelNode 有两个输入（inputs），对应的 RelSubset 记为 <span id="MathJax-Element-2-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-6" class="mjx-math"><span id="MJXc-Node-7" class="mjx-mrow"><span id="MJXc-Node-8" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-9" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-10" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">1、<span id="MathJax-Element-3-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-11" class="mjx-math"><span id="MJXc-Node-12" class="mjx-mrow"><span id="MJXc-Node-13" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-14" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-15" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">2（假设 <span id="MathJax-Element-4-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-16" class="mjx-math"><span id="MJXc-Node-17" class="mjx-mrow"><span id="MJXc-Node-18" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-19" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-20" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">1、<span id="MathJax-Element-5-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-21" class="mjx-math"><span id="MJXc-Node-22" class="mjx-mrow"><span id="MJXc-Node-23" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-24" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-25" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">2 不再有输入 RelNode），其 cost 分别为 2和5，那么 <span id="MathJax-Element-6-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-26" class="mjx-math"><span id="MJXc-Node-27" class="mjx-mrow"><span id="MJXc-Node-28" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-29" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-30" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">1 的 importance 为</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><br>Importance of <span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">1 = <span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mfrac&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mrow&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 2.302em; padding: 0 0.12em"><span class="mjx-numerator" style="font-size: 70.7%; width: 3.256em; top: -1.305em"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">2<span class="mjx-denominator" style="font-size: 70.7%; width: 3.256em; bottom: -0.68em"><span class="mjx-mrow"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">3<span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em">+<span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">2<span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em">+<span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">5<span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.284em; width: 2.302em"><span class="mjx-vsize" style="height: 1.404em; vertical-align: -0.481em"> <span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.331em">⋅</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>0.5 = 0.1</p>
<p>Importance of <span id="MathJax-Element-10-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-49" class="mjx-math"><span id="MJXc-Node-50" class="mjx-mrow"><span id="MJXc-Node-51" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-52" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-53" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">2</span></span></span></span></span></span></span></span></span></span></p>
<p><span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-msubsup"><span class="mjx-base"><span class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em"><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em"><span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mfrac&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mrow&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 2.302em; padding: 0 0.12em"><span class="mjx-numerator" style="font-size: 70.7%; width: 3.256em; top: -1.305em"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em"><span class="mjx-denominator" style="font-size: 70.7%; width: 3.256em; bottom: -0.68em"><span class="mjx-mrow"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em"><span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em"><span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em"><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.284em; width: 2.302em"><span class="mjx-vsize" style="height: 1.404em; vertical-align: -0.481em"><span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.331em">= <span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mfrac&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;mrow&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 2.302em; padding: 0 0.12em"><span class="mjx-numerator" style="font-size: 70.7%; width: 3.256em; top: -1.327em"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">5<span class="mjx-denominator" style="font-size: 70.7%; width: 3.256em; bottom: -0.68em"><span class="mjx-mrow"><span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">3<span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em">+<span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">2<span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em">+<span class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">5<span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.284em; width: 2.302em"><span class="mjx-vsize" style="height: 1.419em; vertical-align: -0.481em"> <span class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;/math&gt;"><span class="mjx-math"><span class="mjx-mrow"><span class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.331em">⋅</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>0.5 = 0.25</p>
<p>其中，2代表的是 <span id="MathJax-Element-13-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-67" class="mjx-math"><span id="MJXc-Node-68" class="mjx-mrow"><span id="MJXc-Node-69" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-70" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-71" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">1</span></span></span></span></span></span></span></span></span></span></p>
<p><span id="MathJax-Element-7-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-31" class="mjx-math"><span id="MJXc-Node-32" class="mjx-mrow"><span id="MJXc-Node-33" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-34" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em"><span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-35" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em"><span id="MathJax-Element-8-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mfrac&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mrow&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;"><span id="MJXc-Node-36" class="mjx-math"><span id="MJXc-Node-37" class="mjx-mrow"><span id="MJXc-Node-38" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 2.302em; padding: 0 0.12em"><span class="mjx-numerator" style="font-size: 70.7%; width: 3.256em; top: -1.305em"><span id="MJXc-Node-39" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em"><span class="mjx-denominator" style="font-size: 70.7%; width: 3.256em; bottom: -0.68em"><span id="MJXc-Node-40" class="mjx-mrow"><span id="MJXc-Node-41" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em"><span id="MJXc-Node-42" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em"><span id="MJXc-Node-43" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em"><span id="MJXc-Node-44" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em"><span id="MJXc-Node-45" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em"><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.284em; width: 2.302em"><span class="mjx-vsize" style="height: 1.404em; vertical-align: -0.481em"><span id="MathJax-Element-9-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;/math&gt;"><span id="MJXc-Node-46" class="mjx-math"><span id="MJXc-Node-47" class="mjx-mrow"><span id="MJXc-Node-48" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.331em"><span id="MathJax-Element-11-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mfrac&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;mrow&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;"><span id="MJXc-Node-54" class="mjx-math"><span id="MJXc-Node-55" class="mjx-mrow"><span id="MJXc-Node-56" class="mjx-mfrac"><span class="mjx-box MJXc-stacked" style="width: 2.302em; padding: 0 0.12em"><span class="mjx-numerator" style="font-size: 70.7%; width: 3.256em; top: -1.327em"><span id="MJXc-Node-57" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em"><span class="mjx-denominator" style="font-size: 70.7%; width: 3.256em; bottom: -0.68em"><span id="MJXc-Node-58" class="mjx-mrow"><span id="MJXc-Node-59" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em"><span id="MJXc-Node-60" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em"><span id="MJXc-Node-61" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em"><span id="MJXc-Node-62" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em"><span id="MJXc-Node-63" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em"><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.284em; width: 2.302em"><span class="mjx-vsize" style="height: 1.419em; vertical-align: -0.481em"><span id="MathJax-Element-12-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo&gt;&amp;#x22C5;&lt;/mo&gt;&lt;/math&gt;"><span id="MJXc-Node-64" class="mjx-math"><span id="MJXc-Node-65" class="mjx-mrow"><span id="MJXc-Node-66" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.331em">的 cost，<span id="MathJax-Element-14-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mn&gt;5&lt;/mn&gt;&lt;/math&gt;"><span id="MJXc-Node-72" class="mjx-math"><span id="MJXc-Node-73" class="mjx-mrow"><span id="MJXc-Node-74" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">3<span id="MJXc-Node-75" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em">+<span id="MJXc-Node-76" class="mjx-mn MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.331em">2<span id="MJXc-Node-77" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.276em; padding-bottom: 0.44em">+<span id="MJXc-Node-78" class="mjx-mn MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">5 代表的是 <span id="MathJax-Element-15-Frame" class="mjx-chtml MathJax_CHTML" style="font-size: 122%; position: relative" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;"><span id="MJXc-Node-79" class="mjx-math"><span id="MJXc-Node-80" class="mjx-mrow"><span id="MJXc-Node-81" class="mjx-msubsup"><span class="mjx-base"><span id="MJXc-Node-82" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.221em; padding-bottom: 0.276em">s<span class="mjx-sub" style="font-size: 70.7%; vertical-align: -0.212em; padding-right: 0.071em"><span id="MJXc-Node-83" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.385em; padding-bottom: 0.385em">0 的 cost（本节点的 cost 加上其所有 input 的 cost）。下面看下其具体的代码实现（调用 RuleQueue 中的 <code>recompute()</code> 计算其 importance）：</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.RuleQueue</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Recomputes the importance of the given RelSubset.
 * note：重新计算指定的 RelSubset 的 importance
 * note：如果为 true，即使 subset 没有注册，也会强制 importance 更新
 *
 * @param subset RelSubset whose importance is to be recomputed
 * @param force  if true, forces an importance update even if the subset has
 *               not been registered
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> recompute(RelSubset subset, boolean force) {
  Double previousImportance </span>= subsetImportances.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(subset);
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (previousImportance == <span style="color: rgba(0, 0, 255, 1)">null</span>) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: subset 还没有注册的情况下</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span> (!force) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果不是强制，可以直接先返回
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Subset has not been registered yet. Don't worry about it.</span>
      <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
    }

    previousImportance </span>=<span style="color: rgba(0, 0, 0, 1)"> Double.NEGATIVE_INFINITY;
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 计算器 importance 值</span>
  <span style="color: rgba(0, 0, 255, 1)">double</span> importance =<span style="color: rgba(0, 0, 0, 1)"> computeImportance(subset);
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (previousImportance ==<span style="color: rgba(0, 0, 0, 1)"> importance) {
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">;
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 缓存中更新其 importance</span>
<span style="color: rgba(0, 0, 0, 1)">  updateImportance(subset, importance);
}


</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 计算一个节点的 importance</span>
<span style="color: rgba(0, 0, 255, 1)">double</span><span style="color: rgba(0, 0, 0, 1)"> computeImportance(RelSubset subset) {
  </span><span style="color: rgba(0, 0, 255, 1)">double</span><span style="color: rgba(0, 0, 0, 1)"> importance;
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (subset ==<span style="color: rgba(0, 0, 0, 1)"> planner.root) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> The root always has importance = 1
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: root RelSubset 的 importance 为1</span>
    importance = <span style="color: rgba(128, 0, 128, 1)">1.0</span><span style="color: rgba(0, 0, 0, 1)">;
  } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
    final RelMetadataQuery mq </span>=<span style="color: rgba(0, 0, 0, 1)"> subset.getCluster().getMetadataQuery();

    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> The importance of a subset is the max of its importance to its
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> parents
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 计算其相对于 parent 的最大 importance，多个 parent 的情况下，选择一个最大值</span>
    importance = <span style="color: rgba(128, 0, 128, 1)">0.0</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (RelSubset parent : subset.getParentSubsets(planner)) {
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 计算这个 RelSubset 相对于 parent 的 importance</span>
      final <span style="color: rgba(0, 0, 255, 1)">double</span> childImportance =<span style="color: rgba(0, 0, 0, 1)">
          computeImportanceOfChild(mq, subset, parent);
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 选择最大的 importance</span>
      importance =<span style="color: rgba(0, 0, 0, 1)"> Math.max(importance, childImportance);
    }
  }
  LOGGER.trace(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Importance of [{}] is {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, subset, importance);
  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> importance;
}

</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note：根据 cost 计算 child 相对于 parent 的 importance（这是个相对值）</span>
<span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">double</span><span style="color: rgba(0, 0, 0, 1)"> computeImportanceOfChild(RelMetadataQuery mq, RelSubset child,
    RelSubset parent) {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 获取 parent 的 importance</span>
  final <span style="color: rgba(0, 0, 255, 1)">double</span> parentImportance =<span style="color: rgba(0, 0, 0, 1)"> getImportance(parent);
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 获取对应的 cost 信息</span>
  final <span style="color: rgba(0, 0, 255, 1)">double</span> childCost =<span style="color: rgba(0, 0, 0, 1)"> toDouble(planner.getCost(child, mq));
  final </span><span style="color: rgba(0, 0, 255, 1)">double</span> parentCost =<span style="color: rgba(0, 0, 0, 1)"> toDouble(planner.getCost(parent, mq));
  </span><span style="color: rgba(0, 0, 255, 1)">double</span> alpha = childCost /<span style="color: rgba(0, 0, 0, 1)"> parentCost;
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (alpha &gt;= <span style="color: rgba(128, 0, 128, 1)">1.0</span><span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> child is always less important than parent</span>
    alpha = <span style="color: rgba(128, 0, 128, 1)">0.99</span><span style="color: rgba(0, 0, 0, 1)">;
  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 根据 cost 比列计算其 importance</span>
  final <span style="color: rgba(0, 0, 255, 1)">double</span> importance = parentImportance *<span style="color: rgba(0, 0, 0, 1)"> alpha;
  LOGGER.trace(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Importance of [{}] to its parent [{}] is {} (parent importance={}, child cost={},</span><span style="color: rgba(128, 0, 0, 1)">"</span>
      + <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> parent cost={})</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, child, parent, importance, parentImportance, childCost, parentCost);
  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> importance;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>在 <code>computeImportanceOfChild()</code> 中计算 RelSubset 相对于 parent RelSubset 的 importance 时，一个比较重要的地方就是如何计算 cost，关于 cost 的计算见：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: Computes the cost of a RelNode.</span>
<span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> RelOptCost getCost(RelNode rel, RelMetadataQuery mq) {
  assert rel </span>!= <span style="color: rgba(0, 0, 255, 1)">null</span> : <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">pre-condition: rel != null</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (rel instanceof RelSubset) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果是 RelSubset，证明是已经计算 cost 的 subset</span>
    <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> ((RelSubset) rel).bestCost;
  }
  </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (rel.getTraitSet().getTrait(ConventionTraitDef.INSTANCE)
      </span>==<span style="color: rgba(0, 0, 0, 1)"> Convention.NONE) {
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> costFactory.makeInfiniteCost(); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 这种情况下也会返回 infinite Cost</span>
<span style="color: rgba(0, 0, 0, 1)">  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 计算其 cost</span>
  RelOptCost cost =<span style="color: rgba(0, 0, 0, 1)"> mq.getNonCumulativeCost(rel);
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (!zeroCost.isLt(cost)) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: cost 比0还小的情况
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> cost must be positive, so nudge it</span>
    cost =<span style="color: rgba(0, 0, 0, 1)"> costFactory.makeTinyCost();
  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: RelNode 的 cost 会把其 input 全部加上</span>
  <span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (RelNode input : rel.getInputs()) {
    cost </span>=<span style="color: rgba(0, 0, 0, 1)"> cost.plus(getCost(input, mq));
  }
  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> cost;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>上面就是 RelSubset importance 计算的代码实现，从实现中可以发现这个特点：</p>
<ol>
<li>越靠近 root 的 RelSubset，其 importance 越大，这个带来的好处就是在优化时，会尽量先优化靠近 root 的 RelNode，这样带来的收益也会最大。</li>
</ol>
<h5 id="RuleMatch-的-importance">RuleMatch 的 importance<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h5>
<p>RuleMatch 的 importance 定义为以下两个中比较大的一个（如果对应的 RelSubset 有 importance 的情况下）：</p>
<ol>
<li>这个 RuleMatch 对应 RelSubset（这个 rule match 的 RelSubset）的 importance；</li>
<li>输出的 RelSubset（taget RelSubset）的 importance（如果这个 RelSubset 在 VolcanoPlanner 的缓存中存在的话）。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoRuleMatch</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Computes the importance of this rule match.
 * note：计算 rule match 的 importance
 *
 * @return importance of this rule match
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">double</span><span style="color: rgba(0, 0, 0, 1)"> computeImportance() {
  assert rels[</span><span style="color: rgba(128, 0, 128, 1)">0</span>] != <span style="color: rgba(0, 0, 255, 1)">null</span>; <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: rels[0] 这个 Rule Match 对应的 RelSubset</span>
  RelSubset subset = volcanoPlanner.getSubset(rels[<span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">]);
  </span><span style="color: rgba(0, 0, 255, 1)">double</span> importance = <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (subset != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 获取 RelSubset 的 importance</span>
    importance =<span style="color: rgba(0, 0, 0, 1)"> volcanoPlanner.ruleQueue.getImportance(subset);
  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: Returns a guess as to which subset the result of this rule will belong to.</span>
  final RelSubset targetSubset =<span style="color: rgba(0, 0, 0, 1)"> guessSubset();
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> ((targetSubset != <span style="color: rgba(0, 0, 255, 1)">null</span>) &amp;&amp; (targetSubset !=<span style="color: rgba(0, 0, 0, 1)"> subset)) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> If this rule will generate a member of an equivalence class
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> which is more important, use that importance.
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 获取 targetSubset 的 importance</span>
    final <span style="color: rgba(0, 0, 255, 1)">double</span> targetImportance =<span style="color: rgba(0, 0, 0, 1)">
        volcanoPlanner.ruleQueue.getImportance(targetSubset);
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (targetImportance &gt;<span style="color: rgba(0, 0, 0, 1)"> importance) {
      importance </span>=<span style="color: rgba(0, 0, 0, 1)"> targetImportance;

      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> If the equivalence class is cheaper than the target, bump up
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> the importance of the rule. A converter is an easy way to
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> make the plan cheaper, so we'd hate to miss this opportunity.
      </span><span style="color: rgba(0, 128, 0, 1)">//</span>
      <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> REVIEW: jhyde, 2007/12/21: This rule seems to make sense, but
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> is disabled until it has been proven.
      </span><span style="color: rgba(0, 128, 0, 1)">//</span>
      <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> CHECKSTYLE: IGNORE 3</span>
      <span style="color: rgba(0, 0, 255, 1)">if</span> ((subset != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)
          </span>&amp;&amp;<span style="color: rgba(0, 0, 0, 1)"> subset.bestCost.isLt(targetSubset.bestCost)
          </span>&amp;&amp; <span style="color: rgba(0, 0, 255, 1)">false</span>) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 肯定不会进入</span>
        importance *=<span style="color: rgba(0, 0, 0, 1)">
            targetSubset.bestCost.divideBy(subset.bestCost);
        importance </span>= Math.min(importance, <span style="color: rgba(128, 0, 128, 1)">0.99</span><span style="color: rgba(0, 0, 0, 1)">);
      }
    }
  }

  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> importance;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>RuleMatch 的 importance 主要是决定了在选择 RuleMatch 时，应该先处理哪一个？它本质上还是直接用的 RelSubset 的 importance。</p>
<h3 id="VolcanoPlanner-处理流程">VolcanoPlanner 处理流程<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<p>还是以前面的示例，只不过这里把优化器换成 VolcanoPlanner 来实现，通过这个示例来详细看下 VolcanoPlanner 内部的实现逻辑。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">1. 初始化 VolcanoPlanner 对象，并添加相应的 Rule</span>
VolcanoPlanner planner = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> VolcanoPlanner();
planner.addRelTraitDef(ConventionTraitDef.INSTANCE);
planner.addRelTraitDef(RelDistributionTraitDef.INSTANCE);
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 添加相应的 rule</span>
<span style="color: rgba(0, 0, 0, 1)">planner.addRule(FilterJoinRule.FilterIntoJoinRule.FILTER_ON_JOIN);
planner.addRule(ReduceExpressionsRule.PROJECT_INSTANCE);
planner.addRule(PruneEmptyRules.PROJECT_INSTANCE);
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 添加相应的 ConverterRule</span>
<span style="color: rgba(0, 0, 0, 1)">planner.addRule(EnumerableRules.ENUMERABLE_MERGE_JOIN_RULE);
planner.addRule(EnumerableRules.ENUMERABLE_SORT_RULE);
planner.addRule(EnumerableRules.ENUMERABLE_VALUES_RULE);
planner.addRule(EnumerableRules.ENUMERABLE_PROJECT_RULE);
planner.addRule(EnumerableRules.ENUMERABLE_FILTER_RULE);
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">2. Changes a relational expression to an equivalent one with a different set of traits.</span>
RelTraitSet desiredTraits =<span style="color: rgba(0, 0, 0, 1)">
    relNode.getCluster().traitSet().replace(EnumerableConvention.INSTANCE);
relNode </span>=<span style="color: rgba(0, 0, 0, 1)"> planner.changeTraits(relNode, desiredTraits);
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">3. 通过 VolcanoPlanner 的 setRoot 方法注册相应的 RelNode，并进行相应的初始化操作</span>
<span style="color: rgba(0, 0, 0, 1)">planner.setRoot(relNode);
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">4. 通过动态规划算法找到 cost 最小的 plan</span>
relNode = planner.findBestExp();</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>优化后的结果为：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre>EnumerableSort(sort0=[$<span style="color: rgba(128, 0, 128, 1)">0</span>], dir0=<span style="color: rgba(0, 0, 0, 1)">[ASC])
  EnumerableProject(USER_ID</span>=[$<span style="color: rgba(128, 0, 128, 1)">0</span>], USER_NAME=[$<span style="color: rgba(128, 0, 128, 1)">1</span>], USER_COMPANY=[$<span style="color: rgba(128, 0, 128, 1)">5</span>], USER_AGE=[$<span style="color: rgba(128, 0, 128, 1)">2</span><span style="color: rgba(0, 0, 0, 1)">])
    EnumerableMergeJoin(condition</span>=[=($<span style="color: rgba(128, 0, 128, 1)">0</span>, $<span style="color: rgba(128, 0, 128, 1)">3</span>)], joinType=<span style="color: rgba(0, 0, 0, 1)">[inner])
      EnumerableFilter(condition</span>=[&gt;($<span style="color: rgba(128, 0, 128, 1)">2</span>, <span style="color: rgba(128, 0, 128, 1)">30</span><span style="color: rgba(0, 0, 0, 1)">)])
        EnumerableTableScan(table</span>=<span style="color: rgba(0, 0, 0, 1)">[[USERS]])
      EnumerableFilter(condition</span>=[&gt;($<span style="color: rgba(128, 0, 128, 1)">0</span>, <span style="color: rgba(128, 0, 128, 1)">10</span><span style="color: rgba(0, 0, 0, 1)">)])
        EnumerableTableScan(table</span>=[[JOBS]])</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>在应用 VolcanoPlanner 时，整体分为以下四步：</p>
<ol>
<li>初始化 VolcanoPlanner，并添加相应的 Rule（包括 ConverterRule）；</li>
<li>对 RelNode 做等价转换，这里只是改变其物理属性（<code>Convention</code>）；</li>
<li>通过 VolcanoPlanner 的 <code>setRoot()</code> 方法注册相应的 RelNode，并进行相应的初始化操作；</li>
<li>通过动态规划算法找到 cost 最小的 plan；</li>
</ol>
<p>下面来分享一下上面的详细流程。</p>
<h4 id="1-VolcanoPlanner-初始化">1. VolcanoPlanner 初始化<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>在这里总共有三步，分别是 VolcanoPlanner 初始化，<code>addRelTraitDef()</code> 添加 RelTraitDef，<code>addRule()</code> 添加 rule，先看下 VolcanoPlanner 的初始化：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Creates a uninitialized &lt;code&gt;VolcanoPlanner&lt;/code&gt;. To fully initialize it, the caller must register the desired set of relations, rules, and calling conventions.
 * note: 创建一个没有初始化的 VolcanoPlanner，如果要进行初始化，调用者必须注册 set of relations、rules、calling conventions.
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> VolcanoPlanner() {
  </span><span style="color: rgba(0, 0, 255, 1)">this</span>(<span style="color: rgba(0, 0, 255, 1)">null</span>, <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">);
}

</span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Creates a {@code VolcanoPlanner} with a given cost factory.
 * note: 创建 VolcanoPlanner 实例，并制定 costFactory（默认为 VolcanoCost.FACTORY）
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">public</span> VolcanoPlanner(RelOptCostFactory costFactory, <span style="color: rgba(0, 128, 0, 1)">//
</span><span style="color: rgba(0, 0, 0, 1)">    Context externalContext) {
  super(costFactory </span>== <span style="color: rgba(0, 0, 255, 1)">null</span> ? VolcanoCost.FACTORY : costFactory, <span style="color: rgba(0, 128, 0, 1)">//
</span><span style="color: rgba(0, 0, 0, 1)">      externalContext);
  </span><span style="color: rgba(0, 0, 255, 1)">this</span>.zeroCost = <span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">.costFactory.makeZeroCost();
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>这里其实并没有做什么，只是做了一些简单的初始化，如果要想设置相应 RelTraitDef 的话，需要调用 <code>addRelTraitDef()</code> 进行添加，其实现如下：</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 添加 RelTraitDef</span>
@Override <span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> boolean addRelTraitDef(RelTraitDef relTraitDef) {
  </span><span style="color: rgba(0, 0, 255, 1)">return</span> !traitDefs.contains(relTraitDef) &amp;&amp;<span style="color: rgba(0, 0, 0, 1)"> traitDefs.add(relTraitDef);
}</span></pre>
</div>
<p>如果要给 VolcanoPlanner 添加 Rule 的话，需要调用 <code>addRule()</code> 进行添加，<strong>在这个方法里重点做的一步是将具体的 RelNode 与 RelOptRuleOperand 之间的关系记录下来，记录到 <code>classOperands</code> 中</strong>，相当于在优化时，哪个 RelNode 可以应用哪些 Rule 都是记录在这个缓存里的。其实现如下：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 添加 rule</span>
<span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> boolean addRule(RelOptRule rule) {
  </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (locked) {
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">false</span><span style="color: rgba(0, 0, 0, 1)">;
  }
  </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (ruleSet.contains(rule)) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Rule already exists.</span>
    <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">false</span><span style="color: rgba(0, 0, 0, 1)">;
  }
  final boolean added </span>=<span style="color: rgba(0, 0, 0, 1)"> ruleSet.add(rule);
  assert added;

  final String ruleName </span>=<span style="color: rgba(0, 0, 0, 1)"> rule.toString();
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 这里的 ruleNames 允许重复的 key 值，但是这里还是要求 rule description 保持唯一的，与 rule 一一对应</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (ruleNames.put(ruleName, rule.getClass())) {
    Set</span>&lt;Class&gt; x = ruleNames.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(ruleName);
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (x.size() &gt; <span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">) {
      </span><span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> RuntimeException(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Rule description '</span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> ruleName
          </span>+ <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">' is not unique; classes: </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> x);
    }
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 注册一个 rule 的 description（保存在 mapDescToRule 中）</span>
<span style="color: rgba(0, 0, 0, 1)">  mapRuleDescription(rule);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Each of this rule's operands is an 'entry point' for a rule call. Register each operand against all concrete sub-classes that could match it.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 记录每个 sub-classes 与 operand 的关系（如果能 match 的话，就记录一次）。一个 RelOptRuleOperand 只会有一个 class 与之对应，这里找的是 subclass</span>
  <span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (RelOptRuleOperand operand : rule.getOperands()) {
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> (Class&lt;? extends RelNode&gt;<span style="color: rgba(0, 0, 0, 1)"> subClass
        : subClasses(operand.getMatchedClass())) {
      classOperands.put(subClass, operand);
    }
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> If this is a converter rule, check that it operates on one of the
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> kinds of trait we are interested in, and if so, register the rule
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> with the trait.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 对于 ConverterRule 的操作，如果其 ruleTraitDef 类型包含在我们初始化的 traitDefs 中，
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 就注册这个 converterRule 到 ruleTraitDef 中
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果不包含 ruleTraitDef，这个 ConverterRule 在本次优化的过程中是用不到的</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (rule instanceof ConverterRule) {
    ConverterRule converterRule </span>=<span style="color: rgba(0, 0, 0, 1)"> (ConverterRule) rule;

    final RelTrait ruleTrait </span>=<span style="color: rgba(0, 0, 0, 1)"> converterRule.getInTrait();
    final RelTraitDef ruleTraitDef </span>=<span style="color: rgba(0, 0, 0, 1)"> ruleTrait.getTraitDef();
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (traitDefs.contains(ruleTraitDef)) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 这里注册好像也没有用到</span>
      ruleTraitDef.registerConverterRule(<span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">, converterRule);
    }
  }

  </span><span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<h4 id="2-RelNode-changeTraits">2. RelNode changeTraits<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>这里分为两步：</p>
<ol>
<li>通过 RelTraitSet 的 <code>replace()</code> 方法，将 RelTraitSet 中对应的 RelTraitDef 做对应的更新，其他的 RelTrait 不变；</li>
<li>这一步简单来说就是：Changes a relational expression to an equivalent one with a different set of traits，对相应的 RelNode 做 converter 操作，这里实际上也会做很多的内容，这部分会放在第三步讲解，主要是 <code>registerImpl()</code> 方法的实现。</li>
</ol>
<h4 id="3-VolcanoPlanner-setRoot">3. VolcanoPlanner setRoot<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>VolcanoPlanner 会调用 <code>setRoot()</code> 方法注册相应的 Root RelNode，并进行一系列 Volcano 必须的初始化操作，很多的操作都是在这里实现的，这里来详细看下其实现。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner</span>
<span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> setRoot(RelNode rel) {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> We're registered all the rules, and therefore RelNode classes,
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> we're interested in, and have not yet started calling metadata providers.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> So now is a good time to tell the metadata layer what to expect.</span>
<span style="color: rgba(0, 0, 0, 1)">  registerMetadataRels();

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 注册相应的 RelNode，会做一系列的初始化操作, RelNode 会有对应的 RelSubset</span>
  <span style="color: rgba(0, 0, 255, 1)">this</span>.root = registerImpl(rel, <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">);
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (<span style="color: rgba(0, 0, 255, 1)">this</span>.originalRoot == <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 0, 255, 1)">this</span>.originalRoot =<span style="color: rgba(0, 0, 0, 1)"> rel;
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Making a node the root changes its importance.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 重新计算 root subset 的 importance</span>
  <span style="color: rgba(0, 0, 255, 1)">this</span>.ruleQueue.recompute(<span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">.root);
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">Ensures that the subset that is the root relational expression contains converters to all other subsets in its equivalence set.</span>
<span style="color: rgba(0, 0, 0, 1)">  ensureRootConverters();
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>对于 <code>setRoot()</code> 方法来说，核心的处理流程是在 <code>registerImpl()</code> 方法中，在这个方法会进行相应的初始化操作（包括 RelNode 到 RelSubset 的转换、计算 RelSubset 的 importance 等），其他的方法在上面有相应的备注，这里我们看下 <code>registerImpl()</code> 具体做了哪些事情：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Registers a new expression &lt;code&gt;exp&lt;/code&gt; and queues up rule matches.
 * If &lt;code&gt;set&lt;/code&gt; is not null, makes the expression part of that
 * equivalence set. If an identical expression is already registered, we
 * don't need to register this one and nor should we queue up rule matches.
 *
 * note：注册一个新的 expression；对 rule match 进行排队；
 * note：如果 set 不为 null，那么就使 expression 成为等价集合（RelSet）的一部分
 * note：rel：必须是 RelSubset 或者未注册的 RelNode
 * @param rel relational expression to register. Must be either a
 *         {@link RelSubset}, or an unregistered {@link RelNode}
 * @param set set that rel belongs to, or &lt;code&gt;null&lt;/code&gt;
 * @return the equivalence-set
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">private</span><span style="color: rgba(0, 0, 0, 1)"> RelSubset registerImpl(
    RelNode rel,
    RelSet </span><span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">) {
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (rel instanceof RelSubset) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果是 RelSubset 类型，已经注册过了</span>
    <span style="color: rgba(0, 0, 255, 1)">return</span> registerSubset(<span style="color: rgba(0, 0, 255, 1)">set</span>, (RelSubset) rel); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 做相应的 merge</span>
<span style="color: rgba(0, 0, 0, 1)">  }

  assert </span>!isRegistered(rel) : <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">already been registered: </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> rel;
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (rel.getCluster().getPlanner() != <span style="color: rgba(0, 0, 255, 1)">this</span>) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: cluster 中 planner 与这里不同</span>
    <span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> AssertionError(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Relational expression </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> rel
        </span>+ <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> belongs to a different planner than is currently being used.</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Now is a good time to ensure that the relational expression
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> implements the interface required by its calling convention.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 确保 relational expression 可以实施其 calling convention 所需的接口
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 获取 RelNode 的 RelTraitSet</span>
  final RelTraitSet traits =<span style="color: rgba(0, 0, 0, 1)"> rel.getTraitSet();
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 获取其 ConventionTraitDef</span>
  final Convention convention =<span style="color: rgba(0, 0, 0, 1)"> traits.getTrait(ConventionTraitDef.INSTANCE);
  assert convention </span>!= <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">;
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">convention.getInterface().isInstance(rel)
      </span>&amp;&amp; !<span style="color: rgba(0, 0, 0, 1)">(rel instanceof Converter)) {
    </span><span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> AssertionError(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Relational expression </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> rel
        </span>+ <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> has calling-convention </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> convention
        </span>+ <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> but does not implement the required interface '</span><span style="color: rgba(128, 0, 0, 1)">"</span>
        + convention.getInterface() + <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">' of that convention</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
  }
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (traits.size() !=<span style="color: rgba(0, 0, 0, 1)"> traitDefs.size()) {
    </span><span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> AssertionError(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Relational expression </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> rel
        </span>+ <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> does not have the correct number of traits: </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> traits.size()
        </span>+ <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> != </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> traitDefs.size());
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Ensure that its sub-expressions are registered.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 其实现在 AbstractRelNode 对应的方法中，实际上调用的还是 ensureRegistered 方法进行注册
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 将 RelNode 的所有 inputs 注册到 planner 中
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 这里会递归调用 registerImpl 注册 relNode 与 RelSet，直到其 inputs 全部注册
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 返回的是一个 RelSubset 类型</span>
  rel = rel.onRegister(<span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Record its provenance. (Rule call may be null.)
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 记录 RelNode 的来源</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (ruleCallStack.isEmpty()) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 不知道来源时</span>
<span style="color: rgba(0, 0, 0, 1)">    provenanceMap.put(rel, Provenance.EMPTY);
  } </span><span style="color: rgba(0, 0, 255, 1)">else</span> { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 来自 rule 触发的情况</span>
    final VolcanoRuleCall ruleCall =<span style="color: rgba(0, 0, 0, 1)"> ruleCallStack.peek();
    provenanceMap.put(
        rel,
        </span><span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> RuleProvenance(
            ruleCall.rule,
            ImmutableList.copyOf(ruleCall.rels),
            ruleCall.id));
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> If it is equivalent to an existing expression, return the set that
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> the equivalent expression belongs to.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 根据 RelNode 的 digest（摘要，全局唯一）判断其是否已经有对应的 RelSubset，有的话直接放回</span>
  String key =<span style="color: rgba(0, 0, 0, 1)"> rel.getDigest();
  RelNode equivExp </span>= mapDigestToRel.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(key);
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (equivExp == <span style="color: rgba(0, 0, 255, 1)">null</span>) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 还没注册的情况
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> do nothing</span>
  } <span style="color: rgba(0, 0, 255, 1)">else</span> <span style="color: rgba(0, 0, 255, 1)">if</span> (equivExp == rel) {<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 已经有其缓存信息</span>
    <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> getSubset(rel);
  } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
    assert RelOptUtil.equal(
        </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">left</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, equivExp.getRowType(),
        </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">right</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, rel.getRowType(),
        Litmus.THROW);
    RelSet equivSet </span>= getSet(equivExp); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 有 RelSubset 但对应的 RelNode 不同时，这里对其 RelSet 做下 merge</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span> (equivSet != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
      LOGGER.trace(
          </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Register: rel#{} is equivalent to {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, rel.getId(), equivExp.getDescription());
      </span><span style="color: rgba(0, 0, 255, 1)">return</span> registerSubset(<span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">, getSubset(equivExp));
    }
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note： Converters are in the same set as their children.</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (rel instanceof Converter) {
    final RelNode input </span>=<span style="color: rgba(0, 0, 0, 1)"> ((Converter) rel).getInput();
    final RelSet childSet </span>=<span style="color: rgba(0, 0, 0, 1)"> getSet(input);
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> ((<span style="color: rgba(0, 0, 255, 1)">set</span> != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)
        </span>&amp;&amp; (<span style="color: rgba(0, 0, 255, 1)">set</span> !=<span style="color: rgba(0, 0, 0, 1)"> childSet)
        </span>&amp;&amp; (<span style="color: rgba(0, 0, 255, 1)">set</span>.equivalentSet == <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)) {
      LOGGER.trace(
          </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Register #{} {} (and merge sets, because it is a conversion)</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
          rel.getId(), rel.getDigest());
      merge(</span><span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">, childSet);
      registerCount</span>++<span style="color: rgba(0, 0, 0, 1)">;

      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> During the mergers, the child set may have changed, and since
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> we're not registered yet, we won't have been informed. So
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> check whether we are now equivalent to an existing
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> expression.</span>
      <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (fixUpInputs(rel)) {
        rel.recomputeDigest();
        key </span>=<span style="color: rgba(0, 0, 0, 1)"> rel.getDigest();
        RelNode equivRel </span>= mapDigestToRel.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(key);
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> ((equivRel != rel) &amp;&amp; (equivRel != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)) {
          assert RelOptUtil.equal(
              </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">rel rowtype</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
              rel.getRowType(),
              </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">equivRel rowtype</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
              equivRel.getRowType(),
              Litmus.THROW);

          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> make sure this bad rel didn't get into the
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> set in any way (fixupInputs will do this but it
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> doesn't know if it should so it does it anyway)</span>
          <span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">.obliterateRelNode(rel);

          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> There is already an equivalent expression. Use that
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> one, and forget about this one.</span>
          <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> getSubset(equivRel);
        }
      }
    } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
      </span><span style="color: rgba(0, 0, 255, 1)">set</span> =<span style="color: rgba(0, 0, 0, 1)"> childSet;
    }
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Place the expression in the appropriate equivalence set.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 把 expression 放到合适的 等价集 中
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果 RelSet 不存在，这里会初始化一个 RelSet</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (<span style="color: rgba(0, 0, 255, 1)">set</span> == <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 0, 255, 1)">set</span> = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> RelSet(
        nextSetId</span>++<span style="color: rgba(0, 0, 0, 1)">,
        Util.minus(
            RelOptUtil.getVariablesSet(rel),
            rel.getVariablesSet()),
        RelOptUtil.getVariablesUsed(rel));
    </span><span style="color: rgba(0, 0, 255, 1)">this</span>.allSets.add(<span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">);
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Chain to find 'live' equivalent set, just in case several sets are
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> merging at the same time.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 递归查询，一直找到最开始的 语义相等的集合，防止不同集合同时被 merge</span>
  <span style="color: rgba(0, 0, 255, 1)">while</span> (<span style="color: rgba(0, 0, 255, 1)">set</span>.equivalentSet != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 0, 255, 1)">set</span> = <span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">.equivalentSet;
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Allow each rel to register its own rules.</span>
<span style="color: rgba(0, 0, 0, 1)">  registerClass(rel);

  registerCount</span>++<span style="color: rgba(0, 0, 0, 1)">;
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 初始时是 0</span>
  final <span style="color: rgba(0, 0, 255, 1)">int</span> subsetBeforeCount = <span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">.subsets.size();
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 向等价集中添加相应的 RelNode，并更新其 best 信息</span>
  RelSubset subset = addRelToSet(rel, <span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 缓存相关信息，返回的 key 之前对应的 value</span>
  final RelNode xx =<span style="color: rgba(0, 0, 0, 1)"> mapDigestToRel.put(key, rel);
  assert xx </span>== <span style="color: rgba(0, 0, 255, 1)">null</span> || xx ==<span style="color: rgba(0, 0, 0, 1)"> rel : rel.getDigest();

  LOGGER.trace(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Register {} in {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, rel.getDescription(), subset.getDescription());

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> This relational expression may have been registered while we
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> recursively registered its children. If this is the case, we're done.</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (xx != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> subset;
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Create back-links from its children, which makes children more
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> important.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果是 root，初始化其 importance 为 1.0</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (rel == <span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">.root) {
    ruleQueue.subsetImportances.put(
        subset,
        </span><span style="color: rgba(128, 0, 128, 1)">1.0</span>); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> todo: remove</span>
<span style="color: rgba(0, 0, 0, 1)">  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 将 Rel 的 input 对应的 RelSubset 的 parents 设置为当前的 Rel
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 也就是说，一个 RelNode 的 input 为其对应 RelSubset 的 children 节点</span>
  <span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (RelNode input : rel.getInputs()) {
    RelSubset childSubset </span>=<span style="color: rgba(0, 0, 0, 1)"> (RelSubset) input;
    childSubset.</span><span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">.parents.add(rel);

    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Child subset is more important now a new parent uses it.
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 重新计算 RelSubset 的 importance</span>
<span style="color: rgba(0, 0, 0, 1)">    ruleQueue.recompute(childSubset);
  }
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (rel == <span style="color: rgba(0, 0, 255, 1)">this</span>.root) {<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> TODO: 2019-03-11 这里为什么要删除呢？</span>
<span style="color: rgba(0, 0, 0, 1)">    ruleQueue.subsetImportances.remove(subset);
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Remember abstract converters until they're satisfied
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果是 AbstractConverter 示例，添加到 abstractConverters 集合中</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (rel instanceof AbstractConverter) {
    </span><span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">.abstractConverters.add((AbstractConverter) rel);
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> If this set has any unsatisfied converters, try to satisfy them.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: check set.abstractConverters</span>
  checkForSatisfiedConverters(<span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">, rel);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Make sure this rel's subset importance is updated
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 强制更新（重新计算） subset 的 importance</span>
  ruleQueue.recompute(subset, <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 触发所有匹配的 rule，这里是添加到对应的 RuleQueue 中
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Queue up all rules triggered by this relexp's creation.</span>
  fireRules(rel, <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">);

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> It's a new subset.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果是一个 new subset，再做一次触发</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (<span style="color: rgba(0, 0, 255, 1)">set</span>.subsets.size() &gt;<span style="color: rgba(0, 0, 0, 1)"> subsetBeforeCount) {
    fireRules(subset, </span><span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">);
  }

  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> subset;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><code>registerImpl()</code> 处理流程比较复杂，其方法实现，可以简单总结为以下几步：</p>
<ol>
<li>在经过最上面的一些验证之后，会通过 <code>rel.onRegister(this)</code> 这步操作，递归地调用 VolcanoPlanner 的 <code>ensureRegistered()</code> 方法对其 <code>inputs</code> RelNode 进行注册，最后还是调用 <code>registerImpl()</code> 方法先注册叶子节点，然后再父节点，最后到根节点；</li>
<li>根据 RelNode 的 digest 信息（一般这个对于 RelNode 来说是全局唯一的），判断其是否已经存在 <code>mapDigestToRel</code> 缓存中，如果存在的话，那么判断会 RelNode 是否相同，如果相同的话，证明之前已经注册过，直接通过 <code>getSubset()</code> 返回其对应的 RelSubset 信息，否则就对其 RelSubset 做下 merge；</li>
<li>如果 RelNode 对应的 RelSet 为 null，这里会新建一个 RelSet，并通过 <code>addRelToSet()</code> 将 RelNode 添加到 RelSet 中，并且更新 VolcanoPlanner 的 <code>mapRel2Subset</code> 缓存记录（RelNode 与 RelSubset 的对应关系），在 <code>addRelToSet()</code> 的最后还会更新 RelSubset 的 best plan 和 best cost（每当往一个 RelSubset 添加相应的 RelNode 时，都会判断这个 RelNode 是否代表了 best plan，如果是的话，就更新）；</li>
<li>将这个 RelNode 的 inputs 设置为其对应 RelSubset 的 children 节点（实际的操作时，是在 RelSet 的 <code>parents</code> 中记录其父节点）；</li>
<li>强制重新计算当前 RelNode 对应 RelSubset 的 importance；</li>
<li>如果这个 RelSubset 是新建的，会再触发一次 <code>fireRules()</code> 方法（会先对 RelNode 触发一次），遍历找到所有可以 match 的 Rule，对每个 Rule 都会创建一个 VolcanoRuleMatch 对象（会记录 RelNode、RelOptRuleOperand 等信息，RelOptRuleOperand 中又会记录 Rule 的信息），并将这个 VolcanoRuleMatch 添加到对应的 RuleQueue 中（就是前面图中的那个 RuleQueue）。</li>
</ol>
<p>这里，来看下 <code>fireRules()</code> 方法的实现，它的目的是把配置的 RuleMatch 添加到 RuleQueue 中，其实现如下：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Fires all rules matched by a relational expression.
 * note： 触发满足这个 relational expression 的所有 rules
 *
 * @param rel      Relational expression which has just been created (or maybe
 *                 from the queue)
 * @param deferred If true, each time a rule matches, just add an entry to
 *                 the queue.
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> fireRules(
    RelNode rel,
    boolean deferred) {
  </span><span style="color: rgba(0, 0, 255, 1)">for</span> (RelOptRuleOperand operand : classOperands.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(rel.getClass())) {
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (operand.matches(rel)) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: rule 匹配的情况</span>
<span style="color: rgba(0, 0, 0, 1)">      final VolcanoRuleCall ruleCall;
      </span><span style="color: rgba(0, 0, 255, 1)">if</span> (deferred) { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 这里默认都是 true，会把 RuleMatch 添加到 queue 中</span>
        ruleCall = <span style="color: rgba(0, 0, 255, 1)">new</span> DeferringRuleCall(<span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">, operand);
      } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
        ruleCall </span>= <span style="color: rgba(0, 0, 255, 1)">new</span> VolcanoRuleCall(<span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">, operand);
      }
      ruleCall.match(rel);
    }
  }
}

</span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * A rule call which defers its actions. Whereas {@link RelOptRuleCall}
 * invokes the rule when it finds a match, a &lt;code&gt;DeferringRuleCall&lt;/code&gt;
 * creates a {@link VolcanoRuleMatch} which can be invoked later.
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">static</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> DeferringRuleCall extends VolcanoRuleCall {
  DeferringRuleCall(
      VolcanoPlanner planner,
      RelOptRuleOperand operand) {
    super(planner, operand);
  }

  </span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
   * Rather than invoking the rule (as the base method does), creates a
   * {@link VolcanoRuleMatch} which can be invoked later.
   * note：不是直接触发 rule，而是创建一个后续可以被触发的 VolcanoRuleMatch
   </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
  <span style="color: rgba(0, 0, 255, 1)">protected</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> onMatch() {
    final VolcanoRuleMatch match </span>=
        <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> VolcanoRuleMatch(
            volcanoPlanner,
            getOperand0(), </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 其实就是 operand</span>
<span style="color: rgba(0, 0, 0, 1)">            rels,
            nodeInputs);
    volcanoPlanner.ruleQueue.addMatch(match);
  }
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>在上面的方法中，对于匹配的 Rule，将会创建一个 VolcanoRuleMatch 对象，之后再把这个 VolcanoRuleMatch 对象添加到对应的 RuleQueue 中。</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.RuleQueue</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Adds a rule match. The rule-matches are automatically added to all
 * existing {@link PhaseMatchList per-phase rule-match lists} which allow
 * the rule referenced by the match.
 * note：添加一个 rule match（添加到所有现存的 match phase 中）
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> addMatch(VolcanoRuleMatch match) {
  final String matchName </span>=<span style="color: rgba(0, 0, 0, 1)"> match.toString();
  </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (PhaseMatchList matchList : matchListMap.values()) {
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">matchList.names.add(matchName)) {
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Identical match has already been added.</span>
      <span style="color: rgba(0, 0, 255, 1)">continue</span><span style="color: rgba(0, 0, 0, 1)">;
    }

    String ruleClassName </span>=<span style="color: rgba(0, 0, 0, 1)"> match.getRule().getClass().getSimpleName();

    Set</span>&lt;String&gt; phaseRuleSet = phaseRuleMapping.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(matchList.phase);
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果 phaseRuleSet 不为 ALL_RULES，并且 phaseRuleSet 不包含这个 ruleClassName 时，就跳过(其他三个阶段都属于这个情况)
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 在添加 rule match 时，phaseRuleSet 可以控制哪些 match 可以添加、哪些不能添加
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 这里的话，默认只有处在 OPTIMIZE 阶段的 PhaseMatchList 可以添加相应的 rule match</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span> (phaseRuleSet !=<span style="color: rgba(0, 0, 0, 1)"> ALL_RULES) {
      </span><span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">phaseRuleSet.contains(ruleClassName)) {
        </span><span style="color: rgba(0, 0, 255, 1)">continue</span><span style="color: rgba(0, 0, 0, 1)">;
      }
    }

    LOGGER.trace(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{} Rule-match queued: {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, matchList.phase.toString(), matchName);

    matchList.list.add(match);

    matchList.matchMap.put(
        planner.getSubset(match.rels[</span><span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">]), match);
  }
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>到这里 VolcanoPlanner 需要初始化的内容都初始化完成了，下面就到了具体的优化部分。</p>
<h4 id="4-VolcanoPlanner-findBestExp">4. VolcanoPlanner findBestExp<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>VolcanoPlanner 的 <code>findBestExp()</code> 是具体进行优化的地方，先介绍一下这里的优化策略（每进行一次迭代，<code>cumulativeTicks</code> 加1，它记录了总的迭代次数）：</p>
<ol>
<li>第一次找到可执行计划的迭代次数记为 <code>firstFiniteTick</code>，其对应的 Cost 暂时记为 BestCost；</li>
<li>制定下一次优化要达到的目标为 <code>BestCost*0.9</code>，再根据 <code>firstFiniteTick</code> 及当前的迭代次数计算 <code>giveUpTick</code>，这个值代表的意思是：如果迭代次数超过这个值还没有达到优化目标，那么将会放弃迭代，认为当前的 plan 就是 best plan；</li>
<li>如果 RuleQueue 中 RuleMatch 为空，那么也会退出迭代，认为当前的 plan 就是 best plan；</li>
<li>在每次迭代时都会从 RuleQueue 中选择一个 RuleMatch，策略是选择一个最高 importance 的 RuleMatch，可以保证在每次规则优化时都是选择当前优化效果最好的 Rule 去优化；</li>
<li>最后根据 best plan，构建其对应的 RelNode。</li>
</ol>
<p>上面就是 <code>findBestExp()</code> 主要设计理念，这里来看其具体的实现：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">org.apache.calcite.plan.volcano.VolcanoPlanner</span><span style="color: rgba(0, 128, 0, 1)">
/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Finds the most efficient expression to implement the query given via
 * {@link org.apache.calcite.plan.RelOptPlanner#setRoot(org.apache.calcite.rel.RelNode)}.
 *
 * note：找到最有效率的 relational expression，这个算法包含一系列阶段，每个阶段被触发的 rules 可能不同
 * &lt;p&gt;The algorithm executes repeatedly in a series of phases. In each phase
 * the exact rules that may be fired varies. The mapping of phases to rule
 * sets is maintained in the {@link #ruleQueue}.
 *
 * note：在每个阶段，planner 都会初始化这个 RelSubset 的 importance，planner 会遍历 rule queue 中 rules 直到：
 * note：1. rule queue 变为空；
 * note：2. 对于 ambitious planner，最近 cost 不再提高时（具体来说，第一次找到一个可执行计划时，需要达到需要迭代总数的10%或更大）；
 * note：3. 对于 non-ambitious planner，当找到一个可执行的计划就行；
 * &lt;p&gt;In each phase, the planner sets the initial importance of the existing
 * RelSubSets ({@link #setInitialImportance()}). The planner then iterates
 * over the rule matches presented by the rule queue until:
 *
 * &lt;ol&gt;
 * &lt;li&gt;The rule queue becomes empty.&lt;/li&gt;
 * &lt;li&gt;For ambitious planners: No improvements to the plan have been made
 * recently (specifically within a number of iterations that is 10% of the
 * number of iterations necessary to first reach an implementable plan or 25
 * iterations whichever is larger).&lt;/li&gt;
 * &lt;li&gt;For non-ambitious planners: When an implementable plan is found.&lt;/li&gt;
 * &lt;/ol&gt;
 *
 * note：此外，如果每10次迭代之后，没有一个可实现的计划，包含 logical RelNode 的 RelSubSets 将会通过 injectImportanceBoost 给一个 importance；
 * &lt;p&gt;Furthermore, after every 10 iterations without an implementable plan,
 * RelSubSets that contain only logical RelNodes are given an importance
 * boost via {@link #injectImportanceBoost()}. Once an implementable plan is
 * found, the artificially raised importance values are cleared (see
 * {@link #clearImportanceBoost()}).
 *
 * @return the most efficient RelNode tree found for implementing the given
 * query
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
<span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> RelNode findBestExp() {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 确保 root relational expression 的 subset（RelSubset）在它的等价集（RelSet）中包含所有 RelSubset 的 converter
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 来保证 planner 从其他的 subsets 找到的实现方案可以转换为 root，否则可能因为 convention 不同，无法实施</span>
<span style="color: rgba(0, 0, 0, 1)">  ensureRootConverters();
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: materialized views 相关，这里可以先忽略~</span>
<span style="color: rgba(0, 0, 0, 1)">  registerMaterializations();
  </span><span style="color: rgba(0, 0, 255, 1)">int</span> cumulativeTicks = <span style="color: rgba(128, 0, 128, 1)">0</span>; <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 四个阶段通用的变量
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 不同的阶段，总共四个阶段，实际上只有 OPTIMIZE 这个阶段有效，因为其他阶段不会有 RuleMatch</span>
  <span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (VolcanoPlannerPhase phase : VolcanoPlannerPhase.values()) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 在不同的阶段，初始化 RelSubSets 相应的 importance
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: root 节点往下子节点的 importance 都会被初始化</span>
<span style="color: rgba(0, 0, 0, 1)">    setInitialImportance();

    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 默认是 VolcanoCost</span>
    RelOptCost targetCost =<span style="color: rgba(0, 0, 0, 1)"> costFactory.makeHugeCost();
    </span><span style="color: rgba(0, 0, 255, 1)">int</span> tick = <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">int</span> firstFiniteTick = -<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">int</span> splitCount = <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
    </span><span style="color: rgba(0, 0, 255, 1)">int</span> giveUpTick =<span style="color: rgba(0, 0, 0, 1)"> Integer.MAX_VALUE;

    </span><span style="color: rgba(0, 0, 255, 1)">while</span> (<span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">) {
      </span>++<span style="color: rgba(0, 0, 0, 1)">tick;
      </span>++<span style="color: rgba(0, 0, 0, 1)">cumulativeTicks;
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 第一次运行是 false，两个不是一个对象，一个是 costFactory.makeHugeCost， 一个是 costFactory.makeInfiniteCost
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果低于目标 cost，这里再重新设置一个新目标、新的 giveUpTick</span>
      <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (root.bestCost.isLe(targetCost)) {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 本阶段第一次运行，目的是为了调用 clearImportanceBoost 方法，清除相应的 importance 信息</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span> (firstFiniteTick &lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">) {
          firstFiniteTick </span>=<span style="color: rgba(0, 0, 0, 1)"> cumulativeTicks;

          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 对于那些手动提高 importance 的 RelSubset 进行重新计算</span>
<span style="color: rgba(0, 0, 0, 1)">          clearImportanceBoost();
        }
        </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (ambitious) {
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Choose a slightly more ambitious target cost, and
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> try again. If it took us 1000 iterations to find our
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> first finite plan, give ourselves another 100
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> iterations to reduce the cost by 10%.
          </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 设置 target 为当前 best cost 的 0.9，调整相应的目标，再进行优化</span>
          targetCost = root.bestCost.multiplyBy(<span style="color: rgba(128, 0, 128, 1)">0.9</span><span style="color: rgba(0, 0, 0, 1)">);
          </span>++<span style="color: rgba(0, 0, 0, 1)">splitCount;
          </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (impatient) {
            </span><span style="color: rgba(0, 0, 255, 1)">if</span> (firstFiniteTick &lt; <span style="color: rgba(128, 0, 128, 1)">10</span><span style="color: rgba(0, 0, 0, 1)">) {
              </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> It's possible pre-processing can create
              </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> an implementable plan -- give us some time
              </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> to actually optimize it.
              </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 有可能在 pre-processing 阶段就实现一个 implementable plan，所以先设置一个值，后面再去优化</span>
              giveUpTick = cumulativeTicks + <span style="color: rgba(128, 0, 128, 1)">25</span><span style="color: rgba(0, 0, 0, 1)">;
            } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
              giveUpTick </span>=<span style="color: rgba(0, 0, 0, 1)">
                  cumulativeTicks
                      </span>+ Math.max(firstFiniteTick / <span style="color: rgba(128, 0, 128, 1)">10</span>, <span style="color: rgba(128, 0, 128, 1)">25</span><span style="color: rgba(0, 0, 0, 1)">);
            }
          }
        } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
          </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
        }
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 最近没有任何进步（超过 giveUpTick 限制，还没达到目标值），直接采用当前的 best plan</span>
      } <span style="color: rgba(0, 0, 255, 1)">else</span> <span style="color: rgba(0, 0, 255, 1)">if</span> (cumulativeTicks &gt;<span style="color: rgba(0, 0, 0, 1)"> giveUpTick) {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> We haven't made progress recently. Take the current best.</span>
        <span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
      } </span><span style="color: rgba(0, 0, 255, 1)">else</span> <span style="color: rgba(0, 0, 255, 1)">if</span> (root.bestCost.isInfinite() &amp;&amp; ((tick % <span style="color: rgba(128, 0, 128, 1)">10</span>) == <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)) {
        injectImportanceBoost();
      }

      LOGGER.debug(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">PLANNER = {}; TICK = {}/{}; PHASE = {}; COST = {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
          </span><span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">, cumulativeTicks, tick, phase.toString(), root.bestCost);

      VolcanoRuleMatch match </span>=<span style="color: rgba(0, 0, 0, 1)"> ruleQueue.popMatch(phase);
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果没有规则，会直接退出当前的阶段</span>
      <span style="color: rgba(0, 0, 255, 1)">if</span> (match == <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
        </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
      }

      assert match.getRule().matches(match);
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 做相应的规则匹配</span>
<span style="color: rgba(0, 0, 0, 1)">      match.onMatch();

      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> The root may have been merged with another
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> subset. Find the new root subset.</span>
      root =<span style="color: rgba(0, 0, 0, 1)"> canonize(root);
    }

    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 当期阶段完成，移除 ruleQueue 中记录的 rule-match list</span>
<span style="color: rgba(0, 0, 0, 1)">    ruleQueue.phaseCompleted(phase);
  }
  </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (LOGGER.isTraceEnabled()) {
    StringWriter sw </span>= <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> StringWriter();
    final PrintWriter pw </span>= <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> PrintWriter(sw);
    dump(pw);
    pw.flush();
    LOGGER.trace(sw.toString());
  }
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 根据 plan 构建其 RelNode 树</span>
  RelNode cheapest = root.buildCheapestPlan(<span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">);
  </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (LOGGER.isDebugEnabled()) {
    LOGGER.debug(
        </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Cheapest plan:\n{}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, RelOptUtil.toString(cheapest, SqlExplainLevel.ALL_ATTRIBUTES));

    LOGGER.debug(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Provenance:\n{}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, provenance(cheapest));
  }
  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> cheapest;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>整体的流程正如前面所述，这里来看下 RuleQueue 中 <code>popMatch()</code> 方法的实现，它的目的是选择 the highest importance 的 RuleMatch，这个方法的实现如下：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre>/<span style="color: rgba(0, 0, 0, 1)">org.apache.calcite.plan.volcano.RuleQueue
</span><span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)">*
 * Removes the rule match with the highest importance, and returns it.
 *
 * note：返回最高 importance 的 rule，并从 Rule Match 中移除（处理过后的就移除）
 * note：如果集合为空，就返回 null
 * &lt;p&gt;Returns {@code null} if there are no more matches.&lt;/p&gt;
 *
 * &lt;p&gt;Note that the VolcanoPlanner may still decide to reject rule matches
 * which have become invalid, say if one of their operands belongs to an
 * obsolete set or has importance=0.
 *
 * @throws java.lang.AssertionError if this method is called with a phase
 *                              previously marked as completed via
 *                              {@link #phaseCompleted(VolcanoPlannerPhase)}.
 </span><span style="color: rgba(0, 128, 0, 1)">*/</span><span style="color: rgba(0, 0, 0, 1)">
VolcanoRuleMatch popMatch(VolcanoPlannerPhase phase) {
  dump();

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 选择当前阶段对应的 PhaseMatchList</span>
  PhaseMatchList phaseMatchList = matchListMap.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(phase);
  </span><span style="color: rgba(0, 0, 255, 1)">if</span> (phaseMatchList == <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> AssertionError(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Used match list for phase </span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> phase
        </span>+ <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> after phase complete</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
  }

  final List</span>&lt;VolcanoRuleMatch&gt; matchList =<span style="color: rgba(0, 0, 0, 1)"> phaseMatchList.list;
  VolcanoRuleMatch match;
  </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (;;) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 按照前面的逻辑只有在 OPTIMIZE 阶段，PhaseMatchList 才不为空，其他阶段都是空
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 参考 addMatch 方法</span>
    <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (matchList.isEmpty()) {
      </span><span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">;
    }
    </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (LOGGER.isTraceEnabled()) {
      matchList.sort(MATCH_COMPARATOR);
      match </span>= matchList.remove(<span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">);

      StringBuilder b </span>= <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> StringBuilder();
      b.append(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Sorted rule queue:</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
      </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (VolcanoRuleMatch match2 : matchList) {
        final </span><span style="color: rgba(0, 0, 255, 1)">double</span> importance =<span style="color: rgba(0, 0, 0, 1)"> match2.computeImportance();
        b.append(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
        b.append(match2);
        b.append(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> importance </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
        b.append(importance);
      }

      LOGGER.trace(b.toString());
    } </span><span style="color: rgba(0, 0, 255, 1)">else</span> { <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 直接遍历找到 importance 最大的 match（上面先做排序，是为了输出日志）
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> If we're not tracing, it's not worth the effort of sorting the
      </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> list to find the minimum.</span>
      match = <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">;
      </span><span style="color: rgba(0, 0, 255, 1)">int</span> bestPos = -<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">;
      </span><span style="color: rgba(0, 0, 255, 1)">int</span> i = -<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">;
      </span><span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (VolcanoRuleMatch match2 : matchList) {
        </span>++<span style="color: rgba(0, 0, 0, 1)">i;
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> (match == <span style="color: rgba(0, 0, 255, 1)">null</span>
            || MATCH_COMPARATOR.compare(match2, match) &lt; <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">) {
          bestPos </span>=<span style="color: rgba(0, 0, 0, 1)"> i;
          match </span>=<span style="color: rgba(0, 0, 0, 1)"> match2;
        }
      }
      match </span>=<span style="color: rgba(0, 0, 0, 1)"> matchList.remove(bestPos);
    }

    </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (skipMatch(match)) {
      LOGGER.debug(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Skip match: {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, match);
    } </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> {
      </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
    }
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> A rule match's digest is composed of the operand RelNodes' digests,
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> which may have changed if sets have merged since the rule match was
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> enqueued.
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 重新计算一下这个 RuleMatch 的 digest</span>
<span style="color: rgba(0, 0, 0, 1)">  match.recomputeDigest();

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 从 phaseMatchList 移除这个 RuleMatch</span>
<span style="color: rgba(0, 0, 0, 1)">  phaseMatchList.matchMap.remove(
      planner.getSubset(match.rels[</span><span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">]), match);

  LOGGER.debug(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Pop match: {}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, match);
  </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> match;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>到这里，我们就把 VolcanoPlanner 的优化讲述完了，当然并没有面面俱到所有的细节，VolcanoPlanner 的整体处理图如下：</p>
<p><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/14-volcano.png" alt="" width="1000" height="768" class="medium-zoom-image"></p>
<h3 id="一些思考">一些思考<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h3>
<h4 id="1-初始化-RuleQueue-时，添加的-one-useless-rule-name-有什么用？">1. 初始化 RuleQueue 时，添加的 one useless rule name 有什么用？<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>在初始化 RuleQueue 时，会给 VolcanoPlanner 的四个阶段 <code>PRE_PROCESS_MDR, PRE_PROCESS, OPTIMIZE, CLEANUP</code> 都初始化一个 PhaseMatchList 对象（记录这个阶段对应的 RuleMatch），这时候会给其中的三个阶段添加一个 useless rule，如下所示：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 0, 255, 1)">protected</span><span style="color: rgba(0, 0, 0, 1)"> VolcanoPlannerPhaseRuleMappingInitializer
    getPhaseRuleMappingInitializer() {
  </span><span style="color: rgba(0, 0, 255, 1)">return</span> phaseRuleMap -&gt;<span style="color: rgba(0, 0, 0, 1)"> {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Disable all phases except OPTIMIZE by adding one useless rule name.
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 通过添加一个无用的 rule name 来 disable 优化器的其他三个阶段</span>
    phaseRuleMap.<span style="color: rgba(0, 0, 255, 1)">get</span>(VolcanoPlannerPhase.PRE_PROCESS_MDR).add(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">xxx</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
    phaseRuleMap.</span><span style="color: rgba(0, 0, 255, 1)">get</span>(VolcanoPlannerPhase.PRE_PROCESS).add(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">xxx</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
    phaseRuleMap.</span><span style="color: rgba(0, 0, 255, 1)">get</span>(VolcanoPlannerPhase.CLEANUP).add(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">xxx</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
  };
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>开始时还困惑这个什么用？后来看到下面的代码基本就明白了</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> (VolcanoPlannerPhase phase : VolcanoPlannerPhase.values()) {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> empty phases get converted to "all rules"
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">note: 如果阶段对应的 rule set 为空，那么就给这个阶段对应的 rule set 添加一个 【ALL_RULES】
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">也就是只有 OPTIMIZE 这个阶段对应的会添加 ALL_RULES</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span> (phaseRuleMapping.<span style="color: rgba(0, 0, 255, 1)">get</span><span style="color: rgba(0, 0, 0, 1)">(phase).isEmpty()) {
    phaseRuleMapping.put(phase, ALL_RULES);
  }
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>后面在调用 RuleQueue 的 <code>addMatch()</code> 方法会做相应的判断，如果 phaseRuleSet 不为 ALL_RULES，并且 phaseRuleSet 不包含这个 ruleClassName 时，那么就跳过这个 RuleMatch，也就是说实际上只有 <strong>OPTIMIZE</strong> 这个阶段是发挥作用的，其他阶段没有添加任何 RuleMatch。</p>
<h4 id="2-四个-phase-实际上只用了-1个阶段，为什么要设置4个阶段？">2. 四个 phase 实际上只用了 1个阶段，为什么要设置4个阶段？<button class="cnblogs-toc-button" title="显示目录导航" aria-expanded="false"></button></h4>
<p>VolcanoPlanner 的四个阶段 <code>PRE_PROCESS_MDR, PRE_PROCESS, OPTIMIZE, CLEANUP</code>，实际只有 <code>OPTIMIZE</code> 进行真正的优化操作，其他阶段并没有，这里自己是有一些困惑的：</p>
<ol>
<li>为什么要分为4个阶段，在添加 RuleMatch 时，是向四个阶段同时添加，这个设计有什么好处？为什么要优化四次？</li>
<li>设计了4个阶段，为什么默认只用了1个？</li>
</ol>
<p>这两个问题，暂时也没有头绪，有想法的，欢迎交流。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<ol>
<li><a href="https://blog.csdn.net/wangxingxing2006/article/details/78907278" rel="noopener nofollow" target="_blank">HepPlanner源码分析——Calcite</a>；</li>
<li><a href="https://zhuanlan.zhihu.com/p/48735419" rel="noopener nofollow" target="_blank">SQL 查询优化原理与 Volcano Optimizer 介绍</a>；</li>
<li><a href="https://blog.csdn.net/u013007900/article/details/78993101" rel="noopener nofollow" target="_blank">高级数据库十六：查询优化器（二）</a>；</li>
<li><a href="http://rann.cc/2018/08/23/sql-optimized-principles.html" rel="noopener nofollow" target="_blank">【SQL】SQL优化器原理——查询优化器综述</a>；</li>
<li><a href="http://hbasefly.com/2017/03/01/sparksql-catalyst/" rel="noopener nofollow" target="_blank">SparkSQL – 从0到1认识Catalyst</a>；</li>
<li><a href="http://hbasefly.com/2017/05/04/bigdata%EF%BC%8Dcbo/" rel="noopener nofollow" target="_blank">BigData－‘基于代价优化’究竟是怎么一回事？</a>；</li>
<li><a href="https://www.slideshare.net/julianhyde/costbased-query-optimization-in-apache-phoenix-using-apache-calcite?qid=b7a1ca0f-e7bf-49ad-bc51-0615ec8a4971&amp;v=&amp;b=&amp;from_search=4" rel="noopener nofollow" target="_blank">Cost-based Query Optimization in Apache Phoenix using Apache Calcite</a>；</li>
<li><a href="https://cs.uwaterloo.ca/~david/cs848/volcano.pdf" rel="noopener nofollow" target="_blank">The Volcano Optimizer Generator: Extensibility and Efficient Search</a>：Volcano 模型的经典论文；</li>
<li><a href="https://pdfs.semanticscholar.org/c1a3/9da04a072f695e9a7f36bf397fba5c19b93c.pdf?_ga=2.162106044.1003201390.1552806109-329306565.1552806109" rel="noopener nofollow" target="_blank">The Cascades Framework for Query Optimization</a>：Cascades 模型的经典论文。</li>
</ol>
<p>&nbsp;</p>
</div>
<div class="clear"></div>
<div id="blog_post_info_block" role="contentinfo">




    <div id="blog_post_info">
<div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(11795952,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
        <a id="green_channel_follow" onclick="follow(&#39;750998f6-d8da-e611-845c-ac853d9f53ac&#39;);" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_wechat" href="javascript:void(0);" onclick="shareManager.wechatShare()">微信分享</a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/wcgstudy/" target="_blank"><img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/sample_face.gif" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/wcgstudy/">青紫天涯</a>
            <br>
            <a href="https://home.cnblogs.com/u/wcgstudy/followers/">粉丝 - <span class="follower-count">26</span></a>
            <a href="https://home.cnblogs.com/u/wcgstudy/followees/">关注 - <span class="following-count">5</span></a><br>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow" class="follow-tip">
                <a href="javascript:void(0);" onclick="follow(&#39;750998f6-d8da-e611-845c-ac853d9f53ac&#39;);return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(11795952,&#39;Digg&#39;)">
        <span class="diggnum" id="digg_count">0</span>
    </div>
    <div class="buryit" onclick="votePost(11795952,&#39;Bury&#39;)">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
        <div id="vip_tip"><a class="tip" href="https://cnblogs.vip/" target="_blank">升级成为会员</a></div>
</div>

<script type="text/javascript">
    currentDiggType = 0;
</script>
</div>
    <div class="clear"></div>
    <div id="post_next_prev">

    <a href="https://www.cnblogs.com/wcgstudy/p/11795886.html" class="p_n_p_prefix">« </a> 上一篇：    <a href="https://www.cnblogs.com/wcgstudy/p/11795886.html" data-featured-image="" title="发布于 2019-11-05 00:10">Apache Calcite 学习 （一）</a>
    <br>
    <a href="https://www.cnblogs.com/wcgstudy/p/14988784.html" class="p_n_p_prefix">» </a> 下一篇：    <a href="https://www.cnblogs.com/wcgstudy/p/14988784.html" data-featured-image="" title="发布于 2021-07-09 00:36">问题定位小工具</a>

</div>
</div>
		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="1996.6586072749028" data-date-created="BlogServer.Application.Dto.BlogPost.BlogPostDto" data-date-updated="2019-11-05 00:37" aria-expanded="false">2019-11-05 00:37</span>&nbsp;
<a href="https://www.cnblogs.com/wcgstudy">青紫天涯</a>&nbsp;
阅读(<span id="post_view_count">4161</span>)&nbsp;
评论(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(11795952);return false;">收藏</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: &#39;&#39;, targetType: &#39;blogPost&#39;, targetId: &#39;11795952&#39;, targetLink: &#39;https://www.cnblogs.com/wcgstudy/p/11795952.html&#39;, title: &#39;apache calcite 优化器（二）&#39; })">举报</a>
</div>
	</div>
	
	
</div><!--end: topics 文章、评论容器-->
<script>
    var cb_entryId = 11795952, cb_entryCreatedDate = '2019-11-05 00:37', cb_postType = 1, cb_postTitle = 'apache calcite 优化器（二）';
    var allowComments = true, cb_blogId = 494819, cb_blogApp = 'wcgstudy', cb_blogUserGuid = '750998f6-d8da-e611-845c-ac853d9f53ac';
    mermaidRender.render()
    markdown_highlight()
    zoomManager.apply("#cnblogs_post_body img:not(.code_img_closed):not(.code_img_opened)");    
</script>
<a id="!comments"></a>
<div id="blog-comments-placeholder"></div>
<div id="comment_form" class="commentform">
    <a name="commentform"></a>
    <div id="divCommentShow"></div>
    <div id="comment_nav"> 
        <div class="comment-nav-right">
            <span id="span_refresh_tips"></span><a href="https://www.cnblogs.com/wcgstudy/p/11795952.html#" onclick="return RefreshPage();">刷新页面</a><a href="https://www.cnblogs.com/wcgstudy/p/11795952.html#top">返回顶部</a>
        </div>
    </div>
    <div id="comment_form_container"><div class="login_tips">
    登录后才能查看或发表评论，立即 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return account.login(&#39;!comments&#39;);">登录</a> 或者
    <a href="https://www.cnblogs.com/">逛逛</a> 博客园首页
</div>
</div>
    <div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
        <div id="cnblogs_ch"><a href="http://www.uccpsoft.com/index.htm" target="_blank" onclick="gtag(&#39;event&#39;, &#39;click&#39;, {&#39;event_category&#39;: &#39;ad&#39;, &#39;event_label&#39;: &#39;T2-UCanCode&#39;})">【推荐】100%开源！大型工业跨平台软件C++源码提供，建模，组态！</a><br><a href="https://www.trae.com.cn/?utm_source=advertising&amp;utm_medium=cnblogs_ug_cpa&amp;utm_term=hw_trae_cnblogs" target="_blank" onclick="gtag(&#39;event&#39;, &#39;click&#39;, {&#39;event_category&#39;: &#39;ad&#39;, &#39;event_label&#39;: &#39;T2-字节-Trae&#39;})">【推荐】国内首个AI IDE，深度理解中文开发场景，立即下载体验Trae</a><br><a href="https://www.cnblogs.com/cmt/p/18669224" target="_blank" onclick="gtag(&#39;event&#39;, &#39;click&#39;, {&#39;event_category&#39;: &#39;ad&#39;, &#39;event_label&#39;: &#39;T2-凌霞软件&#39;})">【推荐】凌霞软件回馈社区，携手博客园推出1Panel与Halo联合会员</a><br><a href="http://ishell.cc/" target="_blank" onclick="gtag(&#39;event&#39;, &#39;click&#39;, {&#39;event_category&#39;: &#39;ad&#39;, &#39;event_label&#39;: &#39;T2-IShell&#39;})">【推荐】轻量又高性能的 SSH 工具 IShell：AI 加持，快人一步</a><br></div>
    <div id="opt_under_post"></div>
        <div id="blog_c1" class="under-post-card">
            <a href="https://www.trae.com.cn/?utm_source=advertising&amp;utm_medium=cnblogs_ug_cpa&amp;utm_term=hw_trae_cnblogs" rel="nofollow" target="_blank" onclick="countCreativeClicks(&#39;C1-字节-trae&#39;)">
                <img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/35695-20250422130943631-261509646.jpg" onload="countCreativeImpressions(&#39;C1-字节-trae&#39;)" alt="">
                <span id="c1_impression" style="display:none"></span>
            </a>
        </div>
    <div id="under_post_card1"><div class="under-post-card">
<b>编辑推荐：</b>
<br>

· <a href="https://www.cnblogs.com/huangxincheng/p/18838356" target="_blank">记一次 .NET某旅行社酒店管理系统 卡死分析</a>
    <br>
· <a href="https://www.cnblogs.com/whuanle/p/18837493" target="_blank">长文讲解 MCP 和案例实战</a>
    <br>
· <a href="https://www.cnblogs.com/whuanle/p/18832422" target="_blank">Hangfire Redis 实现秒级定时任务，使用 CQRS 实现动态执行代码</a>
    <br>
· <a href="https://www.cnblogs.com/WoodJim/p/18834505" target="_blank">Android编译时动态插入代码原理与实践</a>
    <br>
· <a href="https://www.cnblogs.com/code-daily/p/18830657" target="_blank">解锁.NET 9性能优化黑科技：从内存管理到Web性能的最全指南</a>
    <br>
</div></div>
    <div id="under_post_card2"><div class="itnews under-post-card">
    <b>阅读排行：</b>
    <br>
 ·          <a href="https://www.cnblogs.com/xueweihan/p/18839789" target="_blank">一天 Star 破万的开源项目「GitHub 热点速览」</a>
        <br>
 ·          <a href="https://www.cnblogs.com/anai/p/18839434" target="_blank">别再堆文档了，大模型时代知识库应该这样建</a>
        <br>
 ·          <a href="https://www.cnblogs.com/12lisu/p/18840181" target="_blank">瞧瞧别人家的日期处理，那叫一个优雅！</a>
        <br>
 ·          <a href="https://www.cnblogs.com/Can-daydayup/p/18839314" target="_blank">C#/.NET/.NET Core技术前沿周刊 | 第 35 期（2025年4.14-4.20）</a>
        <br>
 ·          <a href="https://www.cnblogs.com/mingupupu/p/18838910" target="_blank">在Avalonia/C#中使用依赖注入过程记录</a>
        <br>
</div></div>
    <div id="HistoryToday" class="under-post-card"></div>
    <script type="text/javascript">
        var commentManager = new blogCommentManager();
        commentManager.renderComments(0);
        fixPostBody();
        window.footnoteTipManager.generateFootnoteTips();

            window.tocManager.displayDisableTocTips = false;
            window.tocManager.generateToc();
            
                setTimeout(function() { countViews(cb_blogId, cb_entryId); }, 50);
            
            deliverT2();
            deliverC1C2();
            loadNewsAndKb();
            
                LoadPostCategoriesTags(cb_blogId, cb_entryId);
            
            LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
            GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
            loadOptUnderPost();
            GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
                </script>
</div>

</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			<div id="sidebar_news" class="newsItem">
    <!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news">    
    <div id="sidebar_news_content">
<div id="profile_block">
    昵称：
    <a href="https://home.cnblogs.com/u/wcgstudy/">
        青紫天涯
    </a>
    <br>
    园龄：
    <a href="https://home.cnblogs.com/u/wcgstudy/" title="入园时间：2017-01-15">
        8年3个月
    </a>
    <br>
    粉丝：
    <a class="follower-count" href="https://home.cnblogs.com/u/wcgstudy/followers/">
        26
    </a>
    <br>
    关注：
    <a class="folowing-count" href="https://home.cnblogs.com/u/wcgstudy/followees/">
        5
    </a>
    <div id="p_b_follow" class="follow-tip">
<a href="javascript:void(0)" onclick="follow(&#39;750998f6-d8da-e611-845c-ac853d9f53ac&#39;)">+加关注</a></div>
    <script>getFollowStatus('750998f6-d8da-e611-845c-ac853d9f53ac');</script>
</div>
</div>
</div>
<script>loadBlogNews();</script>
</div>

 
</div>
<div id="sidebar_c3"></div>
			<div id="calendar"><div id="blog-calendar" style="">

<table id="blogCalendar" class="Cal" cellspacing="0" cellpadding="0" title="Calendar" border="0">
    <tbody>
        <tr>
            <td colspan="7">
                <table class="CalTitle" cellspacing="0" border="0">
                    <tbody>
                        <tr>
                            <td class="CalNextPrev">
                                <a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2025/03/23&#39;); return false;">&lt;</a>
                            </td>
                            <td align="center">2025年4月</td>
                            <td align="right" class="CalNextPrev">
                                <a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2025/05/23&#39;); return false;">&gt;</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    <tr>
        <th class="CalDayHeader" align="center" abbr="日" scope="col">日</th>
        <th class="CalDayHeader" align="center" abbr="一" scope="col">一</th>
        <th class="CalDayHeader" align="center" abbr="二" scope="col">二</th>
        <th class="CalDayHeader" align="center" abbr="三" scope="col">三</th>
        <th class="CalDayHeader" align="center" abbr="四" scope="col">四</th>
        <th class="CalDayHeader" align="center" abbr="五" scope="col">五</th>
        <th class="CalDayHeader" align="center" abbr="六" scope="col">六</th>
    </tr>
            <tr>
                            <td class="CalOtherMonthDay" align="center">30</td>
                            <td class="CalOtherMonthDay" align="center">31</td>
                        <td class="" align="center">
                            1
                        </td>
                        <td class="" align="center">
                            2
                        </td>
                        <td class="" align="center">
                            3
                        </td>
                        <td class="" align="center">
                            4
                        </td>
                    <td class="CalWeekendDay" align="center">
                        5
                    </td>
            </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            6
                        </td>
                            <td class="" align="center">
                                7
                            </td>
                            <td class="" align="center">
                                8
                            </td>
                            <td class="" align="center">
                                9
                            </td>
                            <td class="" align="center">
                                10
                            </td>
                            <td class="" align="center">
                                11
                            </td>
                        <td class="CalWeekendDay" align="center">
                            12
                        </td>
                </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            13
                        </td>
                            <td class="" align="center">
                                14
                            </td>
                            <td class="" align="center">
                                15
                            </td>
                            <td class="" align="center">
                                16
                            </td>
                            <td class="" align="center">
                                17
                            </td>
                            <td class="" align="center">
                                18
                            </td>
                        <td class="CalWeekendDay" align="center">
                            19
                        </td>
                </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            20
                        </td>
                            <td class="" align="center">
                                21
                            </td>
                            <td class="" align="center">
                                22
                            </td>
                            <td class="CalTodayDay" align="center">
                                23
                            </td>
                            <td class="" align="center">
                                24
                            </td>
                            <td class="" align="center">
                                25
                            </td>
                        <td class="CalWeekendDay" align="center">
                            26
                        </td>
                </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            27
                        </td>
                            <td class="" align="center">
                                28
                            </td>
                            <td class="" align="center">
                                29
                            </td>
                            <td class="" align="center">
                                30
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                1
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                2
                            </td>
                        <td class="CalOtherMonthDay" align="center">
                            3
                        </td>
                </tr>
                <tr>
                        <td class="CalOtherMonthDay" align="center">
                            4
                        </td>
                            <td class="CalOtherMonthDay" align="center">
                                5
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                6
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                7
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                8
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                9
                            </td>
                        <td class="CalOtherMonthDay" align="center">
                            10
                        </td>
                </tr>
    </tbody>
</table></div><script>loadBlogDefaultCalendar();</script></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"><!-- 搜索 -->
<div id="sidebar_search" class="sidebar-block">
    <div class="mySearch my-search">
        <h3 class="catListTitle">搜索</h3>
        <div id="sidebar_search_box">
            <div id="widget_my_zzk" class="div_my_zzk">
                <input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk">
            </div>
            
        </div>
    </div>
</div>

<!-- 常用链接 -->
<div id="sidebar_shortcut" class="sidebar-block"><div class="catListLink">
<h3 class="catListTitle">
常用链接
</h3>
<ul>
    <li><a href="https://www.cnblogs.com/wcgstudy/p/" title="我的博客的随笔列表">我的随笔</a></li>
<li><a href="https://www.cnblogs.com/wcgstudy/MyComments.html" title="我的发表过的评论列表">我的评论</a></li>
<li><a href="https://www.cnblogs.com/wcgstudy/OtherPosts.html" title="我评论过的随笔列表">我的参与</a></li>
<li><a href="https://www.cnblogs.com/wcgstudy/comments" title="我的博客的评论列表">最新评论</a></li>
<li><a href="https://www.cnblogs.com/wcgstudy/tag/" title="我的博客的标签列表">我的标签</a></li>

    <li><a id="itemListLink" onclick="this.blur();WarpClass(&#39;itemListLink&#39;, &#39;itemListLin_con&#39;);return false;" href="https://www.cnblogs.com/wcgstudy/p/11795952.html#">更多链接</a></li>
</ul>
</div>

</div>

<!-- 最新随笔 -->


<!-- 我的标签 -->
<div id="sidebar_toptags" class="sidebar-block"></div>

<!-- 积分与排名 -->


<!-- 随笔分类、随笔档案、文章分类、新闻分类、相册、链接 -->
<div id="sidebar_categories">

    <div class="catListPostArchive">
        <h3 class="catListTitle">
            
随笔档案


        </h3>

        <ul>
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2022/01" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2022年1月(1)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2021/07" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2021年7月(2)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/11" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年11月(2)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/09" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年9月(6)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/08" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年8月(13)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/07" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年7月(17)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/06" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年6月(8)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/05" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年5月(1)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/04" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年4月(4)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/03" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年3月(8)</a>
 
                </li>                
                <li data-category-list-item-visible="true" style="display: block">
                    
<a href="https://www.cnblogs.com/wcgstudy/p/archive/2019/02" style="--cnb-category-item-link-indent-size: calc(0 * 1em)" class="category-item-link" rel="" target="">2019年2月(3)</a>
 
                </li>                
            
        </ul>
    </div>    
</div>

<!-- 最新评论 -->
<!-- 阅读排行榜 -->
<div id="sidebar_topviewedposts" class="sidebar-block"><div class="catListView">
    <h3 class="catListTitle">
        <a href="https://www.cnblogs.com/wcgstudy/most-viewed" class="sidebar-card-title-a">
    阅读排行榜
</a>

    </h3>
    <div id="TopViewPostsBlock">
        <ul style="word-break:break-all">
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/10984550.html">
                            1. spark连接mysql数据库的几种方式(26747)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/11407557.html">
                            2. 大数据面试总结（一）(17866)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/11273804.html">
                            3. kudu 学习知识点总结（二）(9702)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/11795886.html">
                            4. Apache Calcite 学习 （一）(9471)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/11449000.html">
                            5. elasticsearch 面试总结（一）(9438)
                        </a>
                    </li>
        </ul>
    </div>
</div></div>

<!-- 评论排行榜 -->
<div id="sidebar_topcommentedposts" class="sidebar-block"><div class="catListFeedback">
    <h3 class="catListTitle">
        <a href="https://www.cnblogs.com/wcgstudy/most-commented" class="sidebar-card-title-a">评论排行榜</a>

    </h3>
    <div id="TopFeedbackPostsBlock">
        <ul style="word-break:break-all">
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/11795886.html">
                            1. Apache Calcite 学习 （一）(2)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/15004787.html">
                            2. yarn 简单介绍(1)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/11407607.html">
                            3. spark 内存溢出处理(1)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/11407557.html">
                            4. 大数据面试总结（一）(1)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/wcgstudy/p/10984550.html">
                            5. spark连接mysql数据库的几种方式(1)
                        </a>
                    </li>
        </ul>
    </div>
</div></div>

<!-- 推荐排行榜 -->
<div id="sidebar_topdiggedposts" class="sidebar-block"><div id="topdigg_posts_wrap">
    <div class="catListView">
        <h3 class="catListTitle">
            <a href="https://www.cnblogs.com/wcgstudy/most-liked" class="sidebar-card-title-a">推荐排行榜</a>

        </h3>
        <div id="TopDiggPostsBlock">
            <ul style="word-break: break-all">
                        <li>
                            <a href="https://www.cnblogs.com/wcgstudy/p/11795886.html">
                                1. Apache Calcite 学习 （一）(2)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/wcgstudy/p/11407557.html">
                                2. 大数据面试总结（一）(1)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/wcgstudy/p/11273804.html">
                                3. kudu 学习知识点总结（二）(1)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/wcgstudy/p/11272792.html">
                                4. OLAP与OLTP的比较(1)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/wcgstudy/p/10984550.html">
                                5. spark连接mysql数据库的几种方式(1)
                            </a>
                        </li>
            </ul>
        </div>
    </div>
</div></div><div id="sidebar_recentcomments" class="sidebar-block"><div class="catListComment">
<h3 class="catListTitle"><a href="https://www.cnblogs.com/wcgstudy/comments" class="sidebar-card-title-a">最新评论</a></h3>
    <div class="RecentCommentBlock">
        <ul>
                <li class="recent_comment_title"><a href="https://www.cnblogs.com/wcgstudy/p/11407557.html">1. Re:大数据面试总结（一）</a></li>
                <li class="recent_comment_body"><p>三姐nb</p>
</li>
                <li class="recent_comment_author">--快乐仔hh</li>
                <li class="recent_comment_title"><a href="https://www.cnblogs.com/wcgstudy/p/11795886.html">2. Re:Apache Calcite 学习 （一）</a></li>
                <li class="recent_comment_body"><p>太牛逼了</p>
</li>
                <li class="recent_comment_author">--程序员小柯</li>
                <li class="recent_comment_title"><a href="https://www.cnblogs.com/wcgstudy/p/11407607.html">3. Re:spark 内存溢出处理</a></li>
                <li class="recent_comment_body">不能使用rdd.coalesce方法，这个方法只能减少分区，不能增加分区，不会有shuffle的过程 coalesce(100,true) 第二个参数为true是有shuffle...</li>
                <li class="recent_comment_author">--koneChen</li>
                <li class="recent_comment_title"><a href="https://www.cnblogs.com/wcgstudy/p/15004787.html">4. Re:yarn 简单介绍</a></li>
                <li class="recent_comment_body"><p><a href="https://www.cnblogs.com/wcgstudy/p/11795952.html" target="blank"></a></p>
</li>
                <li class="recent_comment_author">--青紫天涯</li>
                <li class="recent_comment_title"><a href="https://www.cnblogs.com/wcgstudy/p/11795886.html">5. Re:Apache Calcite 学习 （一）</a></li>
                <li class="recent_comment_body"><p>博主写的很详细了，但有些概念真的是很难理解。<br>
博文中示例代码可以上传到仓库吗？想下载下来学习</p>
</li>
                <li class="recent_comment_author">--噜噜噜啊噜</li>
        </ul>
    </div>
</div>

</div>


</div>
                    <script>loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		<!--done-->
Copyright © 2025 青紫天涯
<br><span id="poweredby">Powered by .NET 9.0 on Kubernetes</span>



	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->



    

    <input type="hidden" id="antiforgery_token" value="CfDJ8KL9kPW-LSFBi_9YdTzcC0_a7J7iSbp8DFAueVAYbDX9gT3O-82QSJ5zyMku2L9se7IIbHNDXKWnkvbETYmDHe3gYFdHz1RIFTk_VdEdRB5qek9VSYf1fD8NwP5JLkHTsl0-pPAUjcKPoJ4wrbot0nY">
    <script async="" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/js"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-M95P3TTWJZ');
</script>
<script defer="" src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/hm.js.下载"></script>


<div style="z-index: 998; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; flex-direction: column; align-items: center; justify-content: center">
<div style="background: #fff;padding: 30px; margin: 30px; border-radius: 16px;">
  <div style="width: 200px; height: 200px; background: rgba(255, 255, 255, 0.8); position: absolute; top: -100px; right: -100px; border-radius: 100px"></div>
  <div style="text-align: center; font-size: 18px; margin-bottom: 10px;">点击右上角即可分享</div>
  <img src="./apache calcite 优化器（二） - 青紫天涯 - 博客园_files/35695-20230906145857937-1471873834.gif" alt="微信分享提示">
</div>   
    </div><button class="charm-bar-item charm-bar-handle hidden" type="button" title="显示工具栏"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="logo">
  <style>
    .main {
      fill: #FFF;
    }

    @media (prefers-color-scheme: dark) {
      .main {
        fill: #59E8EB;
      }
    }
  </style>
  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
    <g transform="translate(-240.000000, -192.000000)">
      <g id="VIP_3_line" transform="translate(240.000000, 192.000000)">
        <path d="M24,0 L24,24 L0,24 L0,0 L24,0 Z M12.5934901,23.257841 L12.5819402,23.2595131 L12.5108777,23.2950439 L12.4918791,23.2987469 L12.4918791,23.2987469 L12.4767152,23.2950439 L12.4056548,23.2595131 C12.3958229,23.2563662 12.3870493,23.2590235 12.3821421,23.2649074 L12.3780323,23.275831 L12.360941,23.7031097 L12.3658947,23.7234994 L12.3769048,23.7357139 L12.4804777,23.8096931 L12.4953491,23.8136134 L12.4953491,23.8136134 L12.5071152,23.8096931 L12.6106902,23.7357139 L12.6232938,23.7196733 L12.6232938,23.7196733 L12.6266527,23.7031097 L12.609561,23.275831 C12.6075724,23.2657013 12.6010112,23.2592993 12.5934901,23.257841 L12.5934901,23.257841 Z M12.8583906,23.1452862 L12.8445485,23.1473072 L12.6598443,23.2396597 L12.6498822,23.2499052 L12.6498822,23.2499052 L12.6471943,23.2611114 L12.6650943,23.6906389 L12.6699349,23.7034178 L12.6699349,23.7034178 L12.678386,23.7104931 L12.8793402,23.8032389 C12.8914285,23.8068999 12.9022333,23.8029875 12.9078286,23.7952264 L12.9118235,23.7811639 L12.8776777,23.1665331 C12.8752882,23.1545897 12.8674102,23.1470016 12.8583906,23.1452862 L12.8583906,23.1452862 Z M12.1430473,23.1473072 C12.1332178,23.1423925 12.1221763,23.1452606 12.1156365,23.1525954 L12.1099173,23.1665331 L12.0757714,23.7811639 C12.0751323,23.7926639 12.0828099,23.8018602 12.0926481,23.8045676 L12.108256,23.8032389 L12.3092106,23.7104931 L12.3186497,23.7024347 L12.3186497,23.7024347 L12.3225043,23.6906389 L12.340401,23.2611114 L12.337245,23.2485176 L12.337245,23.2485176 L12.3277531,23.2396597 L12.1430473,23.1473072 Z" id="MingCute" fill-rule="nonzero"></path>
        <path class="main" d="M2.33789,4.86283 C1.86918,4.02957 2.47132,3 3.42736,3 L9.70837,3 C10.2488,3 10.7475,3.29076 11.0138,3.7611 L12.9999,7.26995 L14.986,3.7611 C15.2523,3.29076 15.7509,3 16.2914,3 L20.5724,3 C21.5285,3 22.1306,4.02957 21.6619,4.86282 L13.0894,20.1029 C12.6115,20.9525 11.3883,20.9525 10.9104,20.1029 L2.33789,4.86283 Z M4.70974,5 L11.9999,17.9603 L19.29,5 L16.5829,5 L12.9999,11.3301 L9.41685,5 L4.70974,5 Z"></path>
      </g>
    </g>
  </g>
</svg> </button><div class="charm-bar-wrapper"><div class="charm-bar-main"><div class="charm-bar-panel inactive hidden"></div><div class="charm-bar"><a class="charm-bar-item tongyi" target="_blank" title="" href="https://www.trae.com.cn/?utm_source=advertising&amp;utm_medium=cnblogs_ug_cpa&amp;utm_term=hw_trae_cnblogs"><span style="font-size: 22px; font-weight: 500; margin-left: 5px; letter-spacing: 2px; font-family: 500;">AI原生IDE</span></a><button class="charm-bar-item" type="button" title="隐藏工具栏"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"></path>
</svg>
</button></div></div></div></body></html>